<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Arnexu</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-content">
            <a href="inicio.html"><img src="arnexu-64x (1).png" alt="Logo Arnexu"></a>
      <ul class="navbar-menu">
        <li><a href="inicio.html">üè† Inicio</a></li>
        <li><a href="crear.html">‚ûï Crear</a></li>
        <li><a href="chat.html">üí¨ Chat</a></li>
        <li><a href="perfil.html">üë§ Perfil</a></li>
        <li><a href="#" onclick="logout()" style="color: var(--error);">üö™ Salir</a></li>
      </ul>
    </div>
  </nav>

  <!-- Contenedor del Chat -->
  <div class="container-wide" style="margin-top: 30px;">
    <!-- Bot√≥n para volver a la lista en m√≥vil -->
    <button 
      id="btnVolverLista" 
      onclick="volverALista()" 
      style="display: none; margin-bottom: 15px; background: var(--gris-medio); border: none; padding: 10px 20px; border-radius: 8px; color: var(--blanco); font-family: 'Montserrat'; cursor: pointer;"
    >
      ‚Üê Volver a conversaciones
    </button>

    <div class="chat-container">
      <!-- Lista de Conversaciones -->
      <div class="chat-lista" id="chatListaContenedor">
        <h3 style="margin-bottom: 20px; font-size: 20px;">Conversaciones</h3>
        <div id="listaChats">
          <div class="loading" style="text-align: center; padding: 20px;">
            Cargando chats...
          </div>
        </div>
      </div>

      <!-- Ventana de Chat -->
      <div class="chat-ventana" id="chatVentanaContenedor">
        <div id="chatVacio" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--gris-neon); text-align: center;">
          <div>
            <h3 style="font-size: 24px; margin-bottom: 10px;">üí¨</h3>
            <p>Selecciona una conversaci√≥n para empezar</p>
          </div>
        </div>

        <div id="chatActivo" style="display: none; height: 100%; flex-direction: column;">
          <!-- Header del Chat -->
          <div style="padding: 20px; border-bottom: 1px solid var(--gris-medio); display: flex; align-items: center; gap: 12px;">
            <img id="chatAvatarActivo" src="" alt="" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
            <div style="flex: 1;">
              <h3 id="chatNombreActivo" style="font-size: 16px; font-weight: 600;"></h3>
              <p id="chatUsernameActivo" style="font-size: 12px; color: var(--gris-neon);"></p>
            </div>
            <button class="btn-icon" onclick="verPerfilActivo()" title="Ver perfil">
              üë§
            </button>
          </div>

          <!-- Mensajes -->
          <div class="chat-mensajes" id="chatMensajes">
            <div class="loading">Cargando mensajes...</div>
          </div>

          <!-- Input de Mensaje -->
          <div class="chat-input-container">
            <input 
              type="text" 
              id="mensajeInput" 
              class="chat-input" 
              placeholder="Escribe un mensaje..."
              onkeypress="if(event.key === 'Enter') enviarMensaje()"
            >
            <button class="btn btn-primary" onclick="enviarMensaje()">
              Enviar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script>
    let usuarioActual = null;
    let chatActivo = null;
    let usuarioActivoChat = null;
    let intervalActualizacion = null;

    // ============================================
    // PROTEGER P√ÅGINA Y CARGAR CHATS
    // ============================================
    async function inicializar() {
      await protegerPagina();
      usuarioActual = await getCurrentUser();
      
      // Verificar si hay que crear un chat nuevo
      const urlParams = new URLSearchParams(window.location.search);
      const nuevoUsuarioId = urlParams.get('nuevo');
      
      if (nuevoUsuarioId) {
        await crearOAbrirChat(nuevoUsuarioId);
      }
      
      await cargarChats();
    }

    // ============================================
    // CARGAR LISTA DE CHATS
    // ============================================
    async function cargarChats() {
      try {
        const { data: chats, error } = await supabase
          .from('chats')
          .select(`
            *,
            participante1:usuarios!chats_participante1_id_fkey(id, nombre_completo, nombre_usuario, foto_perfil),
            participante2:usuarios!chats_participante2_id_fkey(id, nombre_completo, nombre_usuario, foto_perfil)
          `)
          .or(`participante1_id.eq.${usuarioActual.id},participante2_id.eq.${usuarioActual.id}`)
          .order('ultimo_mensaje_fecha', { ascending: false, nullsFirst: false });

        if (error) throw error;

        const listaDiv = document.getElementById('listaChats');
        
        if (!chats || chats.length === 0) {
          listaDiv.innerHTML = `
            <div class="empty-state" style="padding: 40px 20px;">
              <p style="font-size: 14px;">No tienes conversaciones</p>
              <p style="font-size: 12px; margin-top: 10px;">Inicia una desde el perfil de un usuario</p>
            </div>
          `;
          return;
        }

        listaDiv.innerHTML = chats.map(chat => {
          // Determinar el otro usuario
          const otroUsuario = chat.participante1_id === usuarioActual.id 
            ? chat.participante2 
            : chat.participante1;

          return `
            <div 
              class="chat-item ${chatActivo?.id === chat.id ? 'active' : ''}" 
              onclick="abrirChat('${chat.id}', '${otroUsuario.id}')"
            >
              <img 
                src="${otroUsuario.foto_perfil || 'https://via.placeholder.com/40'}" 
                alt="${otroUsuario.nombre_completo}"
                style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
              >
              <div style="flex: 1; overflow: hidden;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 2px;">${otroUsuario.nombre_completo}</h4>
                <p style="font-size: 12px; color: var(--gris-neon); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  ${chat.ultimo_mensaje || 'Sin mensajes'}
                </p>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error cargando chats:', error);
      }
    }

    // ============================================
    // CREAR O ABRIR CHAT
    // ============================================
    async function crearOAbrirChat(otroUsuarioId) {
      try {
        // Verificar si ya existe un chat entre estos usuarios
        const { data: chatExistente, error: errorBuscar } = await supabase
          .from('chats')
          .select('id')
          .or(`and(participante1_id.eq.${usuarioActual.id},participante2_id.eq.${otroUsuarioId}),and(participante1_id.eq.${otroUsuarioId},participante2_id.eq.${usuarioActual.id})`)
          .single();

        if (chatExistente) {
          await abrirChat(chatExistente.id, otroUsuarioId);
          return;
        }

        // Crear nuevo chat si no existe
        const { data: nuevoChat, error: errorCrear } = await supabase
          .from('chats')
          .insert([{
            participante1_id: usuarioActual.id,
            participante2_id: otroUsuarioId
          }])
          .select()
          .single();

        if (errorCrear) throw errorCrear;

        await abrirChat(nuevoChat.id, otroUsuarioId);

      } catch (error) {
        console.error('Error creando/abriendo chat:', error);
        mostrarNotificacion('Error al crear la conversaci√≥n', 'error');
      }
    }

    // ============================================
    // ABRIR CHAT
    // ============================================
    async function abrirChat(chatId, otroUsuarioId) {
      try {
        chatActivo = { id: chatId };

        // Obtener informaci√≥n del otro usuario
        const { data: otroUsuario, error } = await supabase
          .from('usuarios')
          .select('*')
          .eq('id', otroUsuarioId)
          .single();

        if (error) throw error;

        usuarioActivoChat = otroUsuario;

        // EN M√ìVIL: Ocultar lista y mostrar ventana de chat
        if (window.innerWidth <= 768) {
          document.getElementById('chatListaContenedor').style.display = 'none';
          document.getElementById('chatVentanaContenedor').style.display = 'flex';
          document.getElementById('btnVolverLista').style.display = 'block';
        }

        // Mostrar ventana de chat
        document.getElementById('chatVacio').style.display = 'none';
        document.getElementById('chatActivo').style.display = 'flex';

        // Actualizar header
        document.getElementById('chatAvatarActivo').src = otroUsuario.foto_perfil || 'https://via.placeholder.com/48';
        document.getElementById('chatNombreActivo').textContent = otroUsuario.nombre_completo;
        document.getElementById('chatUsernameActivo').textContent = `@${otroUsuario.nombre_usuario}`;

        // Cargar mensajes
        await cargarMensajes(chatId);

        // Actualizar la lista de chats
        await cargarChats();

        // Configurar actualizaci√≥n autom√°tica
        if (intervalActualizacion) {
          clearInterval(intervalActualizacion);
        }
        intervalActualizacion = setInterval(() => cargarMensajes(chatId, true), 3000);

      } catch (error) {
        console.error('Error abriendo chat:', error);
      }
    }

    // ============================================
    // CARGAR MENSAJES
    // ============================================
    async function cargarMensajes(chatId, silencioso = false) {
      try {
        const { data: mensajes, error } = await supabase
          .from('mensajes')
          .select('*')
          .eq('chat_id', chatId)
          .order('created_at', { ascending: true });

        if (error) throw error;

        const mensajesDiv = document.getElementById('chatMensajes');
        
        if (!silencioso) {
          if (!mensajes || mensajes.length === 0) {
            mensajesDiv.innerHTML = `
              <div class="empty-state">
                <p>No hay mensajes a√∫n</p>
                <p style="font-size: 12px; margin-top: 10px;">Env√≠a el primer mensaje</p>
              </div>
            `;
            return;
          }
        }

        const scrollBottom = mensajesDiv.scrollHeight - mensajesDiv.scrollTop <= mensajesDiv.clientHeight + 100;

        mensajesDiv.innerHTML = mensajes.map(msg => `
          <div class="mensaje ${msg.remitente_id === usuarioActual.id ? 'propio' : ''}">
            <div class="mensaje-contenido">
              <p style="margin-bottom: 5px;">${msg.contenido}</p>
              <small style="font-size: 11px; opacity: 0.7;">
                ${formatearFecha(msg.created_at)}
              </small>
            </div>
          </div>
        `).join('');

        // Auto-scroll si estaba cerca del final
        if (scrollBottom || !silencioso) {
          mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
        }

      } catch (error) {
        console.error('Error cargando mensajes:', error);
      }
    }

    // ============================================
    // ENVIAR MENSAJE
    // ============================================
    async function enviarMensaje() {
      const input = document.getElementById('mensajeInput');
      const contenido = input.value.trim();

      if (!contenido || !chatActivo) return;

      try {
        // Insertar mensaje
        const { error } = await supabase
          .from('mensajes')
          .insert([{
            chat_id: chatActivo.id,
            remitente_id: usuarioActual.id,
            contenido: contenido
          }]);

        if (error) throw error;

        // Actualizar √∫ltimo mensaje del chat
        await supabase
          .from('chats')
          .update({
            ultimo_mensaje: contenido,
            ultimo_mensaje_fecha: new Date().toISOString()
          })
          .eq('id', chatActivo.id);

        // Limpiar input y recargar mensajes
        input.value = '';
        await cargarMensajes(chatActivo.id);
        await cargarChats();

      } catch (error) {
        console.error('Error enviando mensaje:', error);
        mostrarNotificacion('Error al enviar el mensaje', 'error');
      }
    }

    // ============================================
    // VER PERFIL DEL USUARIO ACTIVO
    // ============================================
    function verPerfilActivo() {
      if (usuarioActivoChat) {
        window.location.href = `perfil.html?id=${usuarioActivoChat.id}`;
      }
    }

    // ============================================
    // VOLVER A LA LISTA (PARA M√ìVIL)
    // ============================================
    function volverALista() {
      // Detener actualizaci√≥n autom√°tica
      if (intervalActualizacion) {
        clearInterval(intervalActualizacion);
        intervalActualizacion = null;
      }

      // Mostrar lista, ocultar ventana de chat
      document.getElementById('chatListaContenedor').style.display = 'block';
      document.getElementById('chatVentanaContenedor').style.display = 'none';
      document.getElementById('btnVolverLista').style.display = 'none';

      // Ocultar chat activo
      document.getElementById('chatActivo').style.display = 'none';
      document.getElementById('chatVacio').style.display = 'flex';

      chatActivo = null;
      usuarioActivoChat = null;
    }

    // ============================================
    // MANEJAR CAMBIO DE TAMA√ëO DE PANTALLA
    // ============================================
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        // En pantallas grandes, mostrar ambos paneles
        document.getElementById('chatListaContenedor').style.display = 'block';
        document.getElementById('chatVentanaContenedor').style.display = 'flex';
        document.getElementById('btnVolverLista').style.display = 'none';
      } else {
        // En m√≥vil, mostrar solo uno seg√∫n el estado
        if (chatActivo) {
          document.getElementById('chatListaContenedor').style.display = 'none';
          document.getElementById('chatVentanaContenedor').style.display = 'flex';
          document.getElementById('btnVolverLista').style.display = 'block';
        } else {
          document.getElementById('chatListaContenedor').style.display = 'block';
          document.getElementById('chatVentanaContenedor').style.display = 'none';
          document.getElementById('btnVolverLista').style.display = 'none';
        }
      }
    });

    // ============================================
    // LIMPIAR INTERVALO AL SALIR
    // ============================================
    window.addEventListener('beforeunload', () => {
      if (intervalActualizacion) {
        clearInterval(intervalActualizacion);
      }
    });

    // ============================================
    // INICIALIZAR
    // ============================================
    inicializar();
  </script>
</body>
<footer style="background: var(--gris-oscuro); padding: 30px; margin-top: 50px; border-top: 1px solid var(--gris-medio); text-align: center;">
  <p style="color: var(--gris-neon); margin-bottom: 15px;">¬© 2025 Arnexu. Todos los derechos reservados.</p>
  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
    <a href="legal.html" style="color: var(--gris-neon);">Documentos Legales</a>
    <a href="terminos.html" style="color: var(--gris-neon);">T√©rminos</a>
    <a href="privacidad.html" style="color: var(--gris-neon);">Privacidad</a>
    <a href="cookies.html" style="color: var(--gris-neon);">Cookies</a>
    <a href="confidencialidad.html" style="color: var(--gris-neon);">Confidencialidad</a>
  </div>
</footer>
</html>