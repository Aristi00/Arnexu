<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Arnexu</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js?v=1.0.1"></script>
  <script src="js/app.js?v=1.0.1"></script>
  <style>
    .custom-audio-player {
      background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,150,255,0.1) 100%);
      border-radius: 16px;
      padding: 16px;
      margin: 8px 0;
      border: 1px solid rgba(0,255,136,0.2);
    }
    .audio-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 600;
    }
    .audio-controls-wrapper {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(0,0,0,0.2);
      padding: 12px;
      border-radius: 12px;
    }
    .play-btn {
      width: 50px;
      height: 50px;
      min-width: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00ff88 0%, #00dd77 100%);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 4px 12px rgba(0,255,136,0.3);
      transition: transform 0.1s;
    }
    .play-btn:active {
      transform: scale(0.9);
    }
    .progress-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .progress-track {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #00ff88 0%, #00dd77 100%);
      width: 0%;
      transition: width 0.1s linear;
    }
    .time-info {
      font-size: 12px;
      opacity: 0.8;
      text-align: right;
    }
    .badge-contador {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      padding: 2px 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .chat-item {
      position: relative;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-content">
      <a href="inicio.html"><img src="arnexu-64x (1).png" alt="Logo Arnexu"></a>
      <ul class="navbar-menu">
        <li><a href="inicio.html"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></a></li>
        <li><a href="crear.html"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></li>
        <li style="position: relative;"><a href="chat.html"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></a><span id="badgeGlobal" class="badge-contador" style="display: none; top: 5px; right: 5px;"></span></li>
        <li><a href="perfil.html"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></a></li>
        <li><a href="#" onclick="logout()" style="color: var(--error);"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></a></li>
      </ul>
    </div>
  </nav>

  <div class="container-wide" style="margin-top: 30px;">
    <button id="btnVolverLista" onclick="volverALista()" style="display: none; margin-bottom: 15px; background: var(--gris-medio); border: none; padding: 10px 20px; border-radius: 8px; color: var(--blanco); font-family: 'Montserrat'; cursor: pointer;">‚Üê Volver a conversaciones</button>

    <div class="chat-container">
      <div class="chat-lista" id="chatListaContenedor">
        <h3 style="margin-bottom: 20px; font-size: 20px;">Conversaciones</h3>
        <div id="listaChats"><div class="loading" style="text-align: center; padding: 20px;">Cargando chats...</div></div>
      </div>

      <div class="chat-ventana" id="chatVentanaContenedor">
        <div id="chatVacio" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--gris-neon); text-align: center;">
          <div><h3 style="font-size: 24px; margin-bottom: 10px;">üí¨</h3><p>Selecciona una conversaci√≥n para empezar</p></div>
        </div>

        <div id="chatActivo" style="display: none; height: 100%; flex-direction: column;">
          <div style="padding: 20px; border-bottom: 1px solid var(--gris-medio); display: flex; align-items: center; gap: 12px;">
            <img id="chatAvatarActivo" src="" alt="" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
            <div style="flex: 1;"><h3 id="chatNombreActivo" style="font-size: 16px; font-weight: 600;"></h3><p id="chatUsernameActivo" style="font-size: 12px; color: var(--gris-neon);"></p></div>
            <button class="btn-icon" onclick="verPerfilActivo()" title="Ver perfil">üë§</button>
          </div>
          <div class="chat-mensajes" id="chatMensajes"><div class="loading">Cargando mensajes...</div></div>
          <div class="chat-input-container">
            <input type="file" id="archivoInput" style="display: none;" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" onchange="subirArchivo()">
            <button class="btn-icon" onclick="document.getElementById('archivoInput').click()" title="Adjuntar archivo" style="background: var(--gris-medio);">üìé</button>
            <button class="btn-icon" id="btnVoz" onclick="toggleGrabacion()" title="Grabar mensaje de voz" style="background: var(--gris-medio);">üé§</button>
            <input type="text" id="mensajeInput" class="chat-input" placeholder="Escribe un mensaje..." onkeypress="if(event.key === 'Enter') enviarMensaje()">
            <button class="btn btn-primary" onclick="enviarMensaje()">Enviar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let usuarioActual = null;
    let chatActivo = null;
    let usuarioActivoChat = null;
    let intervalActualizacion = null;
    let ultimosMensajesIds = [];
    let mediaRecorder = null;
    let audioChunks = [];
    let grabando = false;
    let audioPlayers = {};
    let intervalNotificaciones = null;

    function createCustomAudioPlayer(audioUrl, audioId, duration) {
      return `<div class="custom-audio-player"><div class="audio-header"><span style="font-size: 24px;">üé§</span><span>${duration}</span></div><div class="audio-controls-wrapper"><button class="play-btn" onclick="playAudio('${audioId}','${audioUrl}')" id="btn-${audioId}">‚ñ∂</button><div class="progress-wrapper"><div class="progress-track" onclick="seekAudio(event,'${audioId}')"><div class="progress-bar" id="bar-${audioId}"></div></div><div class="time-info" id="time-${audioId}">0:00</div></div></div><audio id="audio-${audioId}" preload="auto" style="display:none"><source src="${audioUrl}" type="audio/webm"><source src="${audioUrl}" type="audio/ogg"><source src="${audioUrl}" type="audio/mpeg"><source src="${audioUrl}" type="audio/mp4"></audio></div>`;
    }

    function playAudio(audioId, audioUrl) {
      const audio = document.getElementById('audio-' + audioId);
      const btn = document.getElementById('btn-' + audioId);
      if (!audio) return;
      if (audio.paused) {
        Object.keys(audioPlayers).forEach(id => {
          const otherAudio = document.getElementById('audio-' + id);
          const otherBtn = document.getElementById('btn-' + id);
          if (otherAudio && !otherAudio.paused) {
            otherAudio.pause();
            if (otherBtn) otherBtn.textContent = '‚ñ∂';
          }
        });
        audio.play().then(() => {
          btn.textContent = '‚è∏';
          if (!audioPlayers[audioId]) {
            audioPlayers[audioId] = true;
            audio.ontimeupdate = () => updateProgress(audioId);
            audio.onended = () => {
              btn.textContent = '‚ñ∂';
              document.getElementById('bar-' + audioId).style.width = '0%';
            };
          }
        }).catch(err => {
          console.error('Error reproduciendo:', err);
          alert('No se pudo reproducir el audio.');
        });
      } else {
        audio.pause();
        btn.textContent = '‚ñ∂';
      }
    }

    function updateProgress(audioId) {
      const audio = document.getElementById('audio-' + audioId);
      const progress = document.getElementById('bar-' + audioId);
      const timeDisplay = document.getElementById('time-' + audioId);
      if (!audio || !progress || !timeDisplay) return;
      const percent = (audio.currentTime / audio.duration) * 100;
      progress.style.width = percent + '%';
      const current = Math.floor(audio.currentTime);
      const mins = Math.floor(current / 60);
      const secs = current % 60;
      timeDisplay.textContent = mins + ':' + secs.toString().padStart(2, '0');
    }

    function seekAudio(event, audioId) {
      const audio = document.getElementById('audio-' + audioId);
      const progressBar = event.currentTarget;
      const clickX = event.offsetX;
      const width = progressBar.offsetWidth;
      const percent = clickX / width;
      audio.currentTime = audio.duration * percent;
    }

    async function inicializar() {
      await protegerPagina();
      usuarioActual = await getCurrentUser();
      const urlParams = new URLSearchParams(window.location.search);
      const nuevoUsuarioId = urlParams.get('nuevo');
      if (nuevoUsuarioId) await crearOAbrirChat(nuevoUsuarioId);
      await cargarChats();
      iniciarActualizacionNotificaciones();
    }

    function iniciarActualizacionNotificaciones() {
      actualizarContadorGlobal();
      if (intervalNotificaciones) clearInterval(intervalNotificaciones);
      intervalNotificaciones = setInterval(actualizarContadorGlobal, 5000);
    }

    async function actualizarContadorGlobal() {
      try {
        const { data: noLeidos, error } = await window.supabaseClient
          .from('mensajes_no_leidos')
          .select('cantidad')
          .eq('usuario_id', usuarioActual.id);

        if (error) throw error;

        const totalNoLeidos = (noLeidos || []).reduce((sum, item) => sum + (item.cantidad || 0), 0);
        const badge = document.getElementById('badgeGlobal');

        if (totalNoLeidos > 0) {
          badge.textContent = totalNoLeidos > 99 ? '99+' : totalNoLeidos;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      } catch (error) {
        console.error('Error actualizando contador global:', error);
      }
    }

    async function cargarChats() {
      try {
        const { data: chats, error } = await window.supabaseClient
          .from('chats')
          .select(`*,participante1:usuarios!chats_participante1_id_fkey(id, nombre_completo, nombre_usuario, foto_perfil),participante2:usuarios!chats_participante2_id_fkey(id, nombre_completo, nombre_usuario, foto_perfil)`)
          .or(`participante1_id.eq.${usuarioActual.id},participante2_id.eq.${usuarioActual.id}`)
          .order('ultimo_mensaje_fecha', { ascending: false, nullsFirst: false });

        if (error) throw error;

        const { data: noLeidos } = await window.supabaseClient
          .from('mensajes_no_leidos')
          .select('chat_id, cantidad')
          .eq('usuario_id', usuarioActual.id);

        const noLeidosMap = {};
        (noLeidos || []).forEach(item => {
          noLeidosMap[item.chat_id] = item.cantidad;
        });

        const listaDiv = document.getElementById('listaChats');
        
        if (!chats || chats.length === 0) {
          listaDiv.innerHTML = '<div class="empty-state" style="padding: 40px 20px;"><p style="font-size: 14px;">No tienes conversaciones</p><p style="font-size: 12px; margin-top: 10px;">Inicia una desde el perfil de un usuario</p></div>';
          return;
        }

        listaDiv.innerHTML = chats.map(chat => {
          const otroUsuario = chat.participante1_id === usuarioActual.id ? chat.participante2 : chat.participante1;
          const cantidadNoLeidos = noLeidosMap[chat.id] || 0;
          return `
            <div class="chat-item ${chatActivo?.id === chat.id ? 'active' : ''}" onclick="abrirChat('${chat.id}', '${otroUsuario.id}')" style="position: relative;">
              <img src="${otroUsuario.foto_perfil || 'https://via.placeholder.com/40'}" alt="${otroUsuario.nombre_completo}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
              <div style="flex: 1; overflow: hidden;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 2px;">${otroUsuario.nombre_completo}</h4>
                <p style="font-size: 12px; color: var(--gris-neon); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${chat.ultimo_mensaje || 'Sin mensajes'}</p>
              </div>
              ${cantidadNoLeidos > 0 ? `<span class="badge-contador" style="position: static; margin-left: 10px;">${cantidadNoLeidos > 99 ? '99+' : cantidadNoLeidos}</span>` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error cargando chats:', error);
      }
    }

    async function crearOAbrirChat(otroUsuarioId) {
      try {
        const { data: chatExistente } = await window.supabaseClient.from('chats').select('id').or(`and(participante1_id.eq.${usuarioActual.id},participante2_id.eq.${otroUsuarioId}),and(participante1_id.eq.${otroUsuarioId},participante2_id.eq.${usuarioActual.id})`).single();
        if (chatExistente) {
          await abrirChat(chatExistente.id, otroUsuarioId);
          return;
        }
        const { data: nuevoChat, error: errorCrear } = await window.supabaseClient.from('chats').insert([{participante1_id: usuarioActual.id, participante2_id: otroUsuarioId}]).select().single();
        if (errorCrear) throw errorCrear;
        await abrirChat(nuevoChat.id, otroUsuarioId);
      } catch (error) {
        console.error('Error creando/abriendo chat:', error);
        mostrarNotificacion('Error al crear la conversaci√≥n', 'error');
      }
    }

    async function abrirChat(chatId, otroUsuarioId) {
      try {
        chatActivo = { id: chatId };
        const { data: otroUsuario, error } = await window.supabaseClient.from('usuarios').select('*').eq('id', otroUsuarioId).single();
        if (error) throw error;
        usuarioActivoChat = otroUsuario;

        await window.supabaseClient.from('mensajes_no_leidos').delete().eq('chat_id', chatId).eq('usuario_id', usuarioActual.id);

        if (window.innerWidth <= 768) {
          document.getElementById('chatListaContenedor').style.display = 'none';
          document.getElementById('chatVentanaContenedor').style.display = 'flex';
          document.getElementById('btnVolverLista').style.display = 'block';
        }
        document.getElementById('chatVacio').style.display = 'none';
        document.getElementById('chatActivo').style.display = 'flex';
        document.getElementById('chatAvatarActivo').src = otroUsuario.foto_perfil || 'https://via.placeholder.com/48';
        document.getElementById('chatNombreActivo').textContent = otroUsuario.nombre_completo;
        document.getElementById('chatUsernameActivo').textContent = '@' + otroUsuario.nombre_usuario;
        ultimosMensajesIds = [];
        audioPlayers = {};
        await cargarMensajes(chatId);
        await cargarChats();
        await actualizarContadorGlobal();
        if (intervalActualizacion) clearInterval(intervalActualizacion);
        intervalActualizacion = setInterval(() => cargarMensajes(chatId, true), 3000);
      } catch (error) {
        console.error('Error abriendo chat:', error);
      }
    }

    async function cargarMensajes(chatId, silencioso = false) {
      try {
        const { data: mensajes, error } = await window.supabaseClient.from('mensajes').select('*').eq('chat_id', chatId).order('created_at', { ascending: true });
        if (error) throw error;

        const { data: mensajesOcultos } = await window.supabaseClient.from('mensajes_ocultos').select('mensaje_id').eq('usuario_id', usuarioActual.id);
        const ocultosSet = new Set((mensajesOcultos || []).map(m => m.mensaje_id));
        const mensajesFiltrados = mensajes.filter(m => !ocultosSet.has(m.id));

        const mensajesDiv = document.getElementById('chatMensajes');
        
        if (!silencioso && (!mensajesFiltrados || mensajesFiltrados.length === 0)) {
          mensajesDiv.innerHTML = '<div class="empty-state"><p>No hay mensajes a√∫n</p><p style="font-size: 12px; margin-top: 10px;">Env√≠a el primer mensaje</p></div>';
          ultimosMensajesIds = [];
          return;
        }

        const nuevosIds = mensajesFiltrados.map(m => m.id);
        if (silencioso && JSON.stringify(nuevosIds) === JSON.stringify(ultimosMensajesIds)) return;

        ultimosMensajesIds = nuevosIds;
        const scrollBottom = mensajesDiv.scrollHeight - mensajesDiv.scrollTop <= mensajesDiv.clientHeight + 100;

        mensajesDiv.innerHTML = mensajesFiltrados.map(msg => {
          let contenido = '';
          const esIA = msg.tipo === 'ia';
          const esMio = msg.remitente_id === usuarioActual.id;
          
          if (msg.tipo === 'imagen') {
            contenido = `<img src="${msg.archivo_url}" alt="Imagen" style="max-width: 100%; border-radius: 8px; margin-bottom: 5px; cursor: pointer;" onclick="window.open('${msg.archivo_url}', '_blank')"><p style="margin: 5px 0;">${msg.contenido || ''}</p>`;
          } else if (msg.tipo === 'video') {
            contenido = `<video controls style="max-width: 100%; border-radius: 8px; margin-bottom: 5px;"><source src="${msg.archivo_url}" type="${msg.archivo_tipo}"></video><p style="margin: 5px 0;">${msg.contenido || ''}</p>`;
          } else if (msg.tipo === 'audio') {
            contenido = createCustomAudioPlayer(msg.archivo_url, msg.id, msg.contenido || 'Mensaje de voz');
          } else if (msg.tipo === 'archivo') {
            contenido = `<a href="${msg.archivo_url}" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; text-decoration: none; color: inherit; margin-bottom: 5px;"><span style="font-size: 24px;">üìÑ</span><div><div style="font-weight: 600;">${msg.archivo_nombre}</div><div style="font-size: 12px; opacity: 0.7;">Clic para descargar</div></div></a><p style="margin: 5px 0;">${msg.contenido || ''}</p>`;
          } else {
            contenido = `<p style="margin-bottom: 5px; white-space: pre-wrap;">${msg.contenido}</p>`;
          }

          let botonesEliminar = '';
          if (esMio) {
            botonesEliminar = `<div style="display: flex; gap: 5px;"><button onclick="eliminarMensaje('${msg.id}', 'solo_yo')" style="background: none; border: none; cursor: pointer; opacity: 0.7; font-size: 12px; padding: 2px 5px;" title="Ocultar para m√≠">üëÅÔ∏è</button><button onclick="eliminarMensaje('${msg.id}', 'para_todos')" style="background: none; border: none; cursor: pointer; opacity: 0.7; font-size: 12px; padding: 2px 5px;" title="Eliminar para todos">‚ùå</button></div>`;
          } else {
            botonesEliminar = `<button onclick="eliminarMensaje('${msg.id}', 'solo_yo')" style="background: none; border: none; cursor: pointer; opacity: 0.7; font-size: 12px; padding: 2px 5px;" title="Ocultar para m√≠">üëÅÔ∏è</button>`;
          }

          return `<div class="mensaje ${esMio ? 'propio' : ''} ${esIA ? 'mensaje-ia' : ''}">${esIA ? '<div style="font-size: 20px; margin-bottom: 5px;">ü§ñ</div>' : ''}<div class="mensaje-contenido">${contenido}<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;"><small style="font-size: 11px; opacity: 0.7;">${formatearFecha(msg.created_at)}</small>${botonesEliminar}</div></div></div>`;
        }).join('');

        if (scrollBottom || !silencioso) mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
      } catch (error) {
        console.error('Error cargando mensajes:', error);
      }
    }

    async function enviarMensaje() {
      const input = document.getElementById('mensajeInput');
      const contenido = input.value.trim();
      if (!contenido || !chatActivo) return;

      try {
        const { data: nuevoMensaje, error } = await window.supabaseClient.from('mensajes').insert([{chat_id: chatActivo.id, remitente_id: usuarioActual.id, contenido: contenido, tipo: 'texto'}]).select().single();
        if (error) throw error;

        await window.supabaseClient.from('chats').update({ultimo_mensaje: contenido, ultimo_mensaje_fecha: new Date().toISOString()}).eq('id', chatActivo.id);

        const otroParticipanteId = usuarioActivoChat.id;
        await window.supabaseClient.from('mensajes_no_leidos').upsert({
          chat_id: chatActivo.id,
          usuario_id: otroParticipanteId,
          cantidad: 1,
          ultimo_mensaje_id: nuevoMensaje.id,
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'chat_id,usuario_id',
          ignoreDuplicates: false
        }).then(async ({ data: existing }) => {
          if (existing && existing.length > 0) {
            await window.supabaseClient.from('mensajes_no_leidos').update({
              cantidad: (existing[0].cantidad || 0) + 1,
              ultimo_mensaje_id: nuevoMensaje.id,
              updated_at: new Date().toISOString()
            }).eq('chat_id', chatActivo.id).eq('usuario_id', otroParticipanteId);
          }
        });

        if (usuarioActivoChat) {
          const { data: publicaciones } = await window.supabaseClient.from('publicaciones').select('id').eq('usuario_id', usuarioActivoChat.id).limit(1);
          if (publicaciones && publicaciones.length > 0) {
            await window.supabaseClient.from('contactos_proyectos').insert([{publicacion_id: publicaciones[0].id, contacto_por: usuarioActual.id}]).then(() => {
              window.supabaseClient.rpc('verificar_emprendedor_serial', { pub_id: publicaciones[0].id });
              window.supabaseClient.rpc('verificar_inversor_interesado', { inv_id: usuarioActual.id });
            });
          }
        }

        input.value = '';
        await cargarMensajes(chatActivo.id);
        await cargarChats();
      } catch (error) {
        console.error('Error enviando mensaje:', error);
        mostrarNotificacion('Error al enviar el mensaje', 'error');
      }
    }

    async function subirArchivo() {
      const fileInput = document.getElementById('archivoInput');
      const file = fileInput.files[0];
      if (!file || !chatActivo) return;

      try {
        mostrarNotificacion('Subiendo archivo...');
        let tipoMensaje = 'archivo';
        if (file.type.startsWith('image/')) tipoMensaje = 'imagen';
        if (file.type.startsWith('video/')) tipoMensaje = 'video';

        const extension = file.name.split('.').pop();
        const nombreArchivo = `${usuarioActual.id}_${Date.now()}.${extension}`;
        
        const { error: uploadError } = await window.supabaseClient.storage.from('arnexu-files').upload(`chat/${nombreArchivo}`, file, {cacheControl: '3600', upsert: false});
        if (uploadError) throw uploadError;

        const { data: urlData } = window.supabaseClient.storage.from('arnexu-files').getPublicUrl(`chat/${nombreArchivo}`);

        const { error } = await window.supabaseClient.from('mensajes').insert([{chat_id: chatActivo.id, remitente_id: usuarioActual.id, contenido: '', tipo: tipoMensaje, archivo_url: urlData.publicUrl, archivo_nombre: file.name, archivo_tipo: file.type}]);
        if (error) throw error;

        const mensajePreview = tipoMensaje === 'imagen' ? 'üì∑ Imagen' : tipoMensaje === 'video' ? 'üé• Video' : `üìÑ ${file.name}`;
        
        await window.supabaseClient.from('chats').update({ultimo_mensaje: mensajePreview, ultimo_mensaje_fecha: new Date().toISOString()}).eq('id', chatActivo.id);

        mostrarNotificacion('Archivo enviado');
        fileInput.value = '';
        await cargarMensajes(chatActivo.id);
        await cargarChats();
      } catch (error) {
        console.error('Error subiendo archivo:', error);
        mostrarNotificacion('Error al subir el archivo', 'error');
      }
    }

    async function toggleGrabacion() {
      if (!chatActivo) {
        mostrarNotificacion('Abre un chat primero', 'error');
        return;
      }
      if (!grabando) await iniciarGrabacion();
      else detenerGrabacion();
    }

    async function iniciarGrabacion() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          mostrarNotificacion('Tu navegador no soporta grabaci√≥n de audio', 'error');
          return;
        }
        const stream = await navigator.mediaDevices.getUserMedia({ audio: {echoCancellation: true, noiseSuppression: true} });
        let mimeType = 'audio/webm';
        const tipos = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg', 'audio/mp4'];
        for (let tipo of tipos) {
          if (MediaRecorder.isTypeSupported(tipo)) {
            mimeType = tipo;
            break;
          }
        }
        mediaRecorder = new MediaRecorder(stream, { mimeType });
        audioChunks = [];
        mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) audioChunks.push(event.data); };
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: mimeType });
          await subirAudio(audioBlob, mimeType);
          stream.getTracks().forEach(track => track.stop());
        };
        mediaRecorder.start();
        grabando = true;
        const btnVoz = document.getElementById('btnVoz');
        btnVoz.style.background = '#ff4444';
        btnVoz.innerHTML = '‚èπÔ∏è';
        mostrarNotificacion('üé§ Grabando...');
      } catch (error) {
        console.error('Error al iniciar grabaci√≥n:', error);
        mostrarNotificacion('Error al acceder al micr√≥fono', 'error');
      }
    }

    function detenerGrabacion() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        grabando = false;
        const btnVoz = document.getElementById('btnVoz');
        btnVoz.style.background = 'var(--gris-medio)';
        btnVoz.innerHTML = 'üé§';
      }
    }

    async function subirAudio(audioBlob, mimeType) {
      if (!chatActivo) return;
      try {
        mostrarNotificacion('Subiendo audio...');
        let extension = 'webm';
        if (mimeType.includes('ogg')) extension = 'ogg';
        else if (mimeType.includes('mp4')) extension = 'mp4';
        else if (mimeType.includes('mpeg')) extension = 'mp3';

        const nombreArchivo = `${usuarioActual.id}_${Date.now()}.${extension}`;
        const { error: uploadError } = await window.supabaseClient.storage.from('arnexu-files').upload(`chat/voice/${nombreArchivo}`, audioBlob, {cacheControl: '3600', upsert: false, contentType: mimeType});
        if (uploadError) throw uploadError;

        const { data: urlData } = window.supabaseClient.storage.from('arnexu-files').getPublicUrl(`chat/voice/${nombreArchivo}`);
        const duracion = Math.round(audioBlob.size / 16000);

        const { error } = await window.supabaseClient.from('mensajes').insert([{chat_id: chatActivo.id, remitente_id: usuarioActual.id, contenido: `Mensaje de voz (${duracion}s)`, tipo: 'audio', archivo_url: urlData.publicUrl, archivo_nombre: `audio_${duracion}s.${extension}`, archivo_tipo: mimeType}]);
        if (error) throw error;

        await window.supabaseClient.from('chats').update({ultimo_mensaje: 'üé§ Mensaje de voz', ultimo_mensaje_fecha: new Date().toISOString()}).eq('id', chatActivo.id);

        mostrarNotificacion('Audio enviado ‚úÖ');
        await cargarMensajes(chatActivo.id);
        await cargarChats();
      } catch (error) {
        console.error('Error subiendo audio:', error);
        mostrarNotificacion('Error al subir el audio', 'error');
      }
    }

    async function eliminarMensaje(mensajeId, tipo) {
      const chatIdActual = chatActivo.id;
      
      if (tipo === 'para_todos') {
        if (!confirm('‚ö†Ô∏è ELIMINAR PARA TODOS\n\nEste mensaje se borrar√° permanentemente para ti y para la otra persona.\n\n¬øEst√°s seguro?')) return;
        try {
          mostrarNotificacion('Eliminando mensaje...');
          const { error } = await window.supabaseClient.from('mensajes').delete().eq('id', mensajeId);
          if (error) throw error;
          mostrarNotificacion('‚úÖ Mensaje eliminado para todos');
          ultimosMensajesIds = [];
          audioPlayers = {};
          await cargarMensajes(chatIdActual, false);
          await cargarChats();
        } catch (error) {
          console.error('‚ùå Error eliminando:', error);
          mostrarNotificacion('Error: No se pudo eliminar el mensaje', 'error');
        }
      } else {
        if (!confirm('üëÅÔ∏è OCULTAR SOLO PARA M√ç\n\nEste mensaje desaparecer√° de tu chat, pero la otra persona a√∫n podr√° verlo.\n\n¬øContinuar?')) return;
        try {
          mostrarNotificacion('Ocultando mensaje...');
          const { error } = await window.supabaseClient.from('mensajes_ocultos').insert([{usuario_id: usuarioActual.id, mensaje_id: mensajeId}]);
          if (error) {
            if (error.code === '23505') {
              mostrarNotificacion('‚ö†Ô∏è Este mensaje ya estaba oculto');
              return;
            }
            throw error;
          }
          mostrarNotificacion('‚úÖ Mensaje oculto para ti');
          ultimosMensajesIds = [];
          audioPlayers = {};
          await cargarMensajes(chatIdActual, false);
        } catch (error) {
          console.error('‚ùå Error ocultando:', error);
          mostrarNotificacion('Error: No se pudo ocultar el mensaje', 'error');
        }
      }
    }

    function verPerfilActivo() {
      if (usuarioActivoChat) window.location.href = `perfil.html?id=${usuarioActivoChat.id}`;
    }

    function volverALista() {
      if (intervalActualizacion) {
        clearInterval(intervalActualizacion);
        intervalActualizacion = null;
      }
      ultimosMensajesIds = [];
      audioPlayers = {};
      document.getElementById('chatListaContenedor').style.display = 'block';
      document.getElementById('chatVentanaContenedor').style.display = 'none';
      document.getElementById('btnVolverLista').style.display = 'none';
      document.getElementById('chatActivo').style.display = 'none';
      document.getElementById('chatVacio').style.display = 'flex';
      chatActivo = null;
      usuarioActivoChat = null;
    }

    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        document.getElementById('chatListaContenedor').style.display = 'block';
        document.getElementById('chatVentanaContenedor').style.display = 'flex';
        document.getElementById('btnVolverLista').style.display = 'none';
      } else {
        if (chatActivo) {
          document.getElementById('chatListaContenedor').style.display = 'none';
          document.getElementById('chatVentanaContenedor').style.display = 'flex';
          document.getElementById('btnVolverLista').style.display = 'block';
        } else {
          document.getElementById('chatListaContenedor').style.display = 'block';
          document.getElementById('chatVentanaContenedor').style.display = 'none';
          document.getElementById('btnVolverLista').style.display = 'none';
        }
      }
    });

    window.addEventListener('beforeunload', () => {
      if (intervalActualizacion) clearInterval(intervalActualizacion);
      if (intervalNotificaciones) clearInterval(intervalNotificaciones);
      if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    });

    inicializar();
  </script>

  <footer style="background: var(--gris-oscuro); padding: 30px; margin-top: 50px; border-top: 1px solid var(--gris-medio); text-align: center;">
    <p style="color: var(--gris-neon); margin-bottom: 15px;">¬© 2025 Arnexu. Todos los derechos reservados.</p>
    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
      <a href="legal.html" style="color: var(--gris-neon);">Documentos Legales</a>
      <a href="terminos.html" style="color: var(--gris-neon);">T√©rminos</a>
      <a href="privacidad.html" style="color: var(--gris-neon);">Privacidad</a>
      <a href="cookies.html" style="color: var(--gris-neon);">Cookies</a>
      <a href="confidencialidad.html" style="color: var(--gris-neon);">Confidencialidad</a>
    </div>
  </footer>
</body>
</html>