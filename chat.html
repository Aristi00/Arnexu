<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Arnexu</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js?v=1.0.1"></script>
<script src="js/app.js?v=1.0.1"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-content">
            <a href="inicio.html"><img src="arnexu-64x (1).png" alt="Logo Arnexu"></a>
      <ul class="navbar-menu">
        <li><a href="inicio.html">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          Inicio
        </a></li>
        <li><a href="crear.html">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="16"></line>
            <line x1="8" y1="12" x2="16" y2="12"></line>
          </svg>
          Crear
        </a></li>
        <li><a href="chat.html">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          Chat
        </a></li>
        <li><a href="perfil.html">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Perfil
        </a></li>
        <li><a href="#" onclick="logout()" style="color: var(--error);">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Cerrar Sesi√≥n
        </a></li>
      </ul>
    </div>
  </nav>

  <!-- Contenedor del Chat -->
  <div class="container-wide" style="margin-top: 30px;">
    <!-- Bot√≥n para volver a la lista en m√≥vil -->
    <button 
      id="btnVolverLista" 
      onclick="volverALista()" 
      style="display: none; margin-bottom: 15px; background: var(--gris-medio); border: none; padding: 10px 20px; border-radius: 8px; color: var(--blanco); font-family: 'Montserrat'; cursor: pointer;"
    >
      ‚Üê Volver a conversaciones
    </button>

    <div class="chat-container">
      <!-- Lista de Conversaciones -->
      <div class="chat-lista" id="chatListaContenedor">
        <h3 style="margin-bottom: 20px; font-size: 20px;">Conversaciones</h3>
        <div id="listaChats">
          <div class="loading" style="text-align: center; padding: 20px;">
            Cargando chats...
          </div>
        </div>
      </div>

      <!-- Ventana de Chat -->
      <div class="chat-ventana" id="chatVentanaContenedor">
        <div id="chatVacio" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--gris-neon); text-align: center;">
          <div>
            <h3 style="font-size: 24px; margin-bottom: 10px;">üí¨</h3>
            <p>Selecciona una conversaci√≥n para empezar</p>
          </div>
        </div>

        <div id="chatActivo" style="display: none; height: 100%; flex-direction: column;">
          <!-- Header del Chat -->
          <div style="padding: 20px; border-bottom: 1px solid var(--gris-medio); display: flex; align-items: center; gap: 12px;">
            <img id="chatAvatarActivo" src="" alt="" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
            <div style="flex: 1;">
              <h3 id="chatNombreActivo" style="font-size: 16px; font-weight: 600;"></h3>
              <p id="chatUsernameActivo" style="font-size: 12px; color: var(--gris-neon);"></p>
            </div>
            <button class="btn-icon" onclick="verPerfilActivo()" title="Ver perfil">
              üë§
            </button>
          </div>

          <!-- Mensajes -->
          <div class="chat-mensajes" id="chatMensajes">
            <div class="loading">Cargando mensajes...</div>
          </div>

          <!-- Input de Mensaje -->
          <div class="chat-input-container">
            <input 
              type="file" 
              id="archivoInput" 
              style="display: none;"
              accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
              onchange="subirArchivo()"
            >
            <button 
              class="btn-icon" 
              onclick="document.getElementById('archivoInput').click()"
              title="Adjuntar archivo"
              style="background: var(--gris-medio);"
            >
              üìé
            </button>
            <button 
              class="btn-icon" 
              id="btnVoz"
              onclick="toggleGrabacion()"
              title="Grabar mensaje de voz"
              style="background: var(--gris-medio);"
            >
              üé§
            </button>
            <input 
              type="text" 
              id="mensajeInput" 
              class="chat-input" 
              placeholder="Escribe un mensaje..."
              onkeypress="if(event.key === 'Enter') enviarMensaje()"
            >
            <button class="btn btn-primary" onclick="enviarMensaje()">
              Enviar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let usuarioActual = null;
    let chatActivo = null;
    let usuarioActivoChat = null;
    let intervalActualizacion = null;

    // ============================================
    // PROTEGER P√ÅGINA Y CARGAR CHATS
    // ============================================
    async function inicializar() {
      await protegerPagina();
      usuarioActual = await getCurrentUser();
      
      // Verificar si hay que crear un chat nuevo
      const urlParams = new URLSearchParams(window.location.search);
      const nuevoUsuarioId = urlParams.get('nuevo');
      
      if (nuevoUsuarioId) {
        await crearOAbrirChat(nuevoUsuarioId);
      }
      
      await cargarChats();
    }

    // ============================================
    // CARGAR LISTA DE CHATS
    // ============================================
    async function cargarChats() {
      try {
        const { data: chats, error } = await window.supabaseClient
          .from('chats')
          .select(`
            *,
            participante1:usuarios!chats_participante1_id_fkey(id, nombre_completo, nombre_usuario, foto_perfil),
            participante2:usuarios!chats_participante2_id_fkey(id, nombre_completo, nombre_usuario, foto_perfil)
          `)
          .or(`participante1_id.eq.${usuarioActual.id},participante2_id.eq.${usuarioActual.id}`)
          .order('ultimo_mensaje_fecha', { ascending: false, nullsFirst: false });

        if (error) throw error;

        const listaDiv = document.getElementById('listaChats');
        
        if (!chats || chats.length === 0) {
          listaDiv.innerHTML = `
            <div class="empty-state" style="padding: 40px 20px;">
              <p style="font-size: 14px;">No tienes conversaciones</p>
              <p style="font-size: 12px; margin-top: 10px;">Inicia una desde el perfil de un usuario</p>
            </div>
          `;
          return;
        }

        listaDiv.innerHTML = chats.map(chat => {
          // Determinar el otro usuario
          const otroUsuario = chat.participante1_id === usuarioActual.id 
            ? chat.participante2 
            : chat.participante1;

          return `
            <div 
              class="chat-item ${chatActivo?.id === chat.id ? 'active' : ''}" 
              onclick="abrirChat('${chat.id}', '${otroUsuario.id}')"
            >
              <img 
                src="${otroUsuario.foto_perfil || 'https://via.placeholder.com/40'}" 
                alt="${otroUsuario.nombre_completo}"
                style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
              >
              <div style="flex: 1; overflow: hidden;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 2px;">${otroUsuario.nombre_completo}</h4>
                <p style="font-size: 12px; color: var(--gris-neon); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  ${chat.ultimo_mensaje || 'Sin mensajes'}
                </p>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error cargando chats:', error);
      }
    }

    // ============================================
    // CREAR O ABRIR CHAT
    // ============================================
    async function crearOAbrirChat(otroUsuarioId) {
      try {
        // Verificar si ya existe un chat entre estos usuarios
        const { data: chatExistente, error: errorBuscar } = await window.supabaseClient
          .select('id')
          .or(`and(participante1_id.eq.${usuarioActual.id},participante2_id.eq.${otroUsuarioId}),and(participante1_id.eq.${otroUsuarioId},participante2_id.eq.${usuarioActual.id})`)
          .single();

        if (chatExistente) {
          await abrirChat(chatExistente.id, otroUsuarioId);
          return;
        }

        // Crear nuevo chat si no existe
        const { data: nuevoChat, error: errorCrear } = await window.supabaseClient
          .from('chats')
          .insert([{
            participante1_id: usuarioActual.id,
            participante2_id: otroUsuarioId
          }])
          .select()
          .single();

        if (errorCrear) throw errorCrear;

        await abrirChat(nuevoChat.id, otroUsuarioId);

      } catch (error) {
        console.error('Error creando/abriendo chat:', error);
        mostrarNotificacion('Error al crear la conversaci√≥n', 'error');
      }
    }

    // ============================================
    // ABRIR CHAT
    // ============================================
    async function abrirChat(chatId, otroUsuarioId) {
      try {
        chatActivo = { id: chatId };

        // Obtener informaci√≥n del otro usuario
        const { data: otroUsuario, error } = await window.supabaseClient
          .from('usuarios')
          .select('*')
          .eq('id', otroUsuarioId)
          .single();

        if (error) throw error;

        usuarioActivoChat = otroUsuario;

        // EN M√ìVIL: Ocultar lista y mostrar ventana de chat
        if (window.innerWidth <= 768) {
          document.getElementById('chatListaContenedor').style.display = 'none';
          document.getElementById('chatVentanaContenedor').style.display = 'flex';
          document.getElementById('btnVolverLista').style.display = 'block';
        }

        // Mostrar ventana de chat
        document.getElementById('chatVacio').style.display = 'none';
        document.getElementById('chatActivo').style.display = 'flex';

        // Actualizar header
        document.getElementById('chatAvatarActivo').src = otroUsuario.foto_perfil || 'https://via.placeholder.com/48';
        document.getElementById('chatNombreActivo').textContent = otroUsuario.nombre_completo;
        document.getElementById('chatUsernameActivo').textContent = `@${otroUsuario.nombre_usuario}`;

        // Cargar mensajes
        await cargarMensajes(chatId);

        // Actualizar la lista de chats
        await cargarChats();

        // Configurar actualizaci√≥n autom√°tica
        if (intervalActualizacion) {
          clearInterval(intervalActualizacion);
        }
        intervalActualizacion = setInterval(() => cargarMensajes(chatId, true), 3000);

      } catch (error) {
        console.error('Error abriendo chat:', error);
      }
    }

    // ============================================
    // CARGAR MENSAJES
    // ============================================
    async function cargarMensajes(chatId, silencioso = false) {
      try {
        const { data: mensajes, error } = await window.supabaseClient
          .from('mensajes')
          .select('*')
          .eq('chat_id', chatId)
          .order('created_at', { ascending: true });

        if (error) throw error;

        const mensajesDiv = document.getElementById('chatMensajes');
        
        if (!silencioso) {
          if (!mensajes || mensajes.length === 0) {
            mensajesDiv.innerHTML = `
              <div class="empty-state">
                <p>No hay mensajes a√∫n</p>
                <p style="font-size: 12px; margin-top: 10px;">Env√≠a el primer mensaje</p>
              </div>
            `;
            return;
          }
        }

        const scrollBottom = mensajesDiv.scrollHeight - mensajesDiv.scrollTop <= mensajesDiv.clientHeight + 100;

        mensajesDiv.innerHTML = mensajes.map(msg => {
          let contenidoHTML = '';
          
          // Mensajes de IA tienen estilo especial
          const esIA = msg.tipo === 'ia';
          const claseExtra = esIA ? 'mensaje-ia' : '';
          const esMio = msg.remitente_id === usuarioActual.id;
          
          if (msg.tipo === 'imagen') {
            contenidoHTML = `
              <img src="${msg.archivo_url}" alt="Imagen" style="max-width: 100%; border-radius: 8px; margin-bottom: 5px; cursor: pointer;" onclick="window.open('${msg.archivo_url}', '_blank')">
              <p style="margin: 5px 0;">${msg.contenido || ''}</p>
            `;
          } else if (msg.tipo === 'video') {
            contenidoHTML = `
              <video controls style="max-width: 100%; border-radius: 8px; margin-bottom: 5px;">
                <source src="${msg.archivo_url}" type="${msg.archivo_tipo}">
              </video>
              <p style="margin: 5px 0;">${msg.contenido || ''}</p>
            `;
          } else if (msg.tipo === 'audio') {
            contenidoHTML = `
              <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 5px;">
                <span style="font-size: 20px;">üé§</span>
                <audio controls style="flex: 1; height: 32px;">
                  <source src="${msg.archivo_url}" type="audio/webm">
                  Tu navegador no soporta audio.
                </audio>
              </div>
              <p style="margin: 5px 0; font-size: 12px; opacity: 0.7;">${msg.contenido || 'Mensaje de voz'}</p>
            `;
          } else if (msg.tipo === 'archivo') {
            contenidoHTML = `
              <a href="${msg.archivo_url}" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; text-decoration: none; color: inherit; margin-bottom: 5px;">
                <span style="font-size: 24px;">üìÑ</span>
                <div>
                  <div style="font-weight: 600;">${msg.archivo_nombre}</div>
                  <div style="font-size: 12px; opacity: 0.7;">Clic para descargar</div>
                </div>
              </a>
              <p style="margin: 5px 0;">${msg.contenido || ''}</p>
            `;
          } else {
            contenidoHTML = `<p style="margin-bottom: 5px; white-space: pre-wrap;">${msg.contenido}</p>`;
          }

          return `
            <div class="mensaje ${esMio ? 'propio' : ''} ${claseExtra}" style="position: relative;">
              ${esIA ? '<div style="font-size: 20px; margin-bottom: 5px;">ü§ñ</div>' : ''}
              <div class="mensaje-contenido">
                ${contenidoHTML}
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                  <small style="font-size: 11px; opacity: 0.7;">
                    ${formatearFecha(msg.created_at)}
                  </small>
                  ${esMio ? `
                    <div style="display: flex; gap: 5px;">
                      <button 
                        onclick="eliminarMensaje('${msg.id}', 'solo_yo')" 
                        style="background: none; border: none; cursor: pointer; opacity: 0.7; font-size: 12px; padding: 2px 5px;"
                        title="Eliminar para m√≠"
                      >
                        üóëÔ∏è
                      </button>
                      <button 
                        onclick="eliminarMensaje('${msg.id}', 'para_todos')" 
                        style="background: none; border: none; cursor: pointer; opacity: 0.7; font-size: 12px; padding: 2px 5px;"
                        title="Eliminar para todos"
                      >
                        ‚ùå
                      </button>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Auto-scroll si estaba cerca del final
        if (scrollBottom || !silencioso) {
          mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
        }

      } catch (error) {
        console.error('Error cargando mensajes:', error);
      }
    }

    // ============================================
    // ENVIAR MENSAJE
    // ============================================
    async function enviarMensaje() {
      const input = document.getElementById('mensajeInput');
      const contenido = input.value.trim();

      if (!contenido || !chatActivo) return;

      try {
        // Insertar mensaje
        const { error } = await window.supabaseClient
          .from('mensajes')
          .insert([{
            chat_id: chatActivo.id,
            remitente_id: usuarioActual.id,
            contenido: contenido,
            tipo: 'texto'
          }]);

        if (error) throw error;

        // Actualizar √∫ltimo mensaje del chat
        await window.supabaseClient
          .from('chats')
          .update({
            ultimo_mensaje: contenido,
            ultimo_mensaje_fecha: new Date().toISOString()
          })
          .eq('id', chatActivo.id);

        // Registrar contacto para sistema de badges
        if (usuarioActivoChat) {
          // Obtener publicaciones del usuario contactado
          const { data: publicaciones } = await window.supabaseClient
            .from('publicaciones')
            .select('id')
            .eq('usuario_id', usuarioActivoChat.id)
            .limit(1);

          if (publicaciones && publicaciones.length > 0) {
            // Registrar contacto
            await window.supabaseClient
              .from('contactos_proyectos')
              .insert([{
                publicacion_id: publicaciones[0].id,
                contacto_por: usuarioActual.id
              }])
              .then(() => {
                // Verificar badges
                window.supabaseClient.rpc('verificar_emprendedor_serial', { pub_id: publicaciones[0].id });
                window.supabaseClient.rpc('verificar_inversor_interesado', { inv_id: usuarioActual.id });
              });
          }
        }

        // Limpiar input y recargar mensajes
        input.value = '';
        await cargarMensajes(chatActivo.id);
        await cargarChats();

      } catch (error) {
        console.error('Error enviando mensaje:', error);
        mostrarNotificacion('Error al enviar el mensaje', 'error');
      }
    }

    // ============================================
    // SUBIR ARCHIVO
    // ============================================
    async function subirArchivo() {
      const fileInput = document.getElementById('archivoInput');
      const file = fileInput.files[0];
      
      if (!file || !chatActivo) return;

      try {
        mostrarNotificacion('Subiendo archivo...');

        // Determinar tipo de archivo
        let tipoMensaje = 'archivo';
        if (file.type.startsWith('image/')) tipoMensaje = 'imagen';
        if (file.type.startsWith('video/')) tipoMensaje = 'video';

        // Subir a Supabase Storage
        const extension = file.name.split('.').pop();
        const nombreArchivo = `${usuarioActual.id}_${Date.now()}.${extension}`;
        
        const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
          .from('arnexu-files')
          .upload(`chat/${nombreArchivo}`, file, {
            cacheControl: '3600',
            upsert: false
          });

        if (uploadError) throw uploadError;

        // Obtener URL p√∫blica
        const { data: urlData } = window.supabaseClient.storage
          .from('arnexu-files')
          .getPublicUrl(`chat/${nombreArchivo}`);

        // Guardar mensaje con archivo
        const { error } = await window.supabaseClient
          .from('mensajes')
          .insert([{
            chat_id: chatActivo.id,
            remitente_id: usuarioActual.id,
            contenido: '',
            tipo: tipoMensaje,
            archivo_url: urlData.publicUrl,
            archivo_nombre: file.name,
            archivo_tipo: file.type
          }]);

        if (error) throw error;

        // Actualizar √∫ltimo mensaje del chat
        const mensajePreview = tipoMensaje === 'imagen' ? 'üì∑ Imagen' : 
                               tipoMensaje === 'video' ? 'üé• Video' : 
                               `üìÑ ${file.name}`;
        
        await window.supabaseClient
          .from('chats')
          .update({
            ultimo_mensaje: mensajePreview,
            ultimo_mensaje_fecha: new Date().toISOString()
          })
          .eq('id', chatActivo.id);

        mostrarNotificacion('Archivo enviado');
        fileInput.value = '';
        await cargarMensajes(chatActivo.id);
        await cargarChats();

      } catch (error) {
        console.error('Error subiendo archivo:', error);
        mostrarNotificacion('Error al subir el archivo', 'error');
      }
    }

    // ============================================
    // ABRIR CHAT CON IA
    // ============================================
    async function abrirChatIA() {
      try {
        // Buscar o crear chat con IA (usuario_id especial)
        const IA_USER_ID = '00000000-0000-0000-0000-000000000000';

        const { data: chatExistente } = await window.supabaseClient
          .from('chats')
          .select('id')
          .or(`and(participante1_id.eq.${usuarioActual.id},participante2_id.eq.${IA_USER_ID}),and(participante1_id.eq.${IA_USER_ID},participante2_id.eq.${usuarioActual.id})`)
          .single();

        if (chatExistente) {
          // Abrir chat existente con IA
          usuarioActivoChat = {
            id: IA_USER_ID,
            nombre_completo: 'Asistente IA de Arnexu',
            nombre_usuario: 'arnexu_ia',
            foto_perfil: 'https://via.placeholder.com/48/00ff88/000000?text=AI'
          };
          
          chatActivo = { id: chatExistente.id };
          
          // Actualizar UI
          document.getElementById('chatVacio').style.display = 'none';
          document.getElementById('chatActivo').style.display = 'flex';
          document.getElementById('chatAvatarActivo').src = usuarioActivoChat.foto_perfil;
          document.getElementById('chatNombreActivo').textContent = usuarioActivoChat.nombre_completo;
          document.getElementById('chatUsernameActivo').textContent = '@' + usuarioActivoChat.nombre_usuario;
          
          await cargarMensajes(chatExistente.id);
        } else {
          // Crear nuevo chat con IA
          const { data: nuevoChat, error } = await window.supabaseClient
            .from('chats')
            .insert([{
              participante1_id: usuarioActual.id,
              participante2_id: IA_USER_ID,
              ultimo_mensaje: 'Chat con IA iniciado',
              ultimo_mensaje_fecha: new Date().toISOString()
            }])
            .select()
            .single();

          if (error) throw error;

          // Enviar mensaje de bienvenida de la IA
          await window.supabaseClient
            .from('mensajes')
            .insert([{
              chat_id: nuevoChat.id,
              remitente_id: IA_USER_ID,
              contenido: '¬°Hola! üëã Soy tu asistente de IA de Arnexu. Puedo ayudarte con:\n\n‚Ä¢ Crear res√∫menes ejecutivos\n‚Ä¢ Dise√±ar estrategias de negocio\n‚Ä¢ Generar ideas de logos\n‚Ä¢ An√°lisis de mercado\n‚Ä¢ Pitch decks\n‚Ä¢ Y mucho m√°s sobre emprendimiento\n\n¬øEn qu√© puedo ayudarte hoy?',
              tipo: 'ia'
            }]);

          // Abrir el chat
          usuarioActivoChat = {
            id: IA_USER_ID,
            nombre_completo: 'Asistente IA de Arnexu',
            nombre_usuario: 'arnexu_ia',
            foto_perfil: 'https://via.placeholder.com/48/00ff88/000000?text=AI'
          };
          
          chatActivo = { id: nuevoChat.id };
          
          document.getElementById('chatVacio').style.display = 'none';
          document.getElementById('chatActivo').style.display = 'flex';
          document.getElementById('chatAvatarActivo').src = usuarioActivoChat.foto_perfil;
          document.getElementById('chatNombreActivo').textContent = usuarioActivoChat.nombre_completo;
          document.getElementById('chatUsernameActivo').textContent = '@' + usuarioActivoChat.nombre_usuario;
          
          await cargarMensajes(nuevoChat.id);
        }

        await cargarChats();

        // Si es m√≥vil, mostrar el chat
        if (window.innerWidth <= 768) {
          document.getElementById('chatListaContenedor').style.display = 'none';
          document.getElementById('chatVentanaContenedor').style.display = 'flex';
          document.getElementById('btnVolverLista').style.display = 'block';
        }

      } catch (error) {
        console.error('Error abriendo chat IA:', error);
        mostrarNotificacion('Error al abrir chat con IA', 'error');
      }
    }

    // ============================================
    // VER PERFIL DEL USUARIO ACTIVO
    // ============================================
    function verPerfilActivo() {
      if (usuarioActivoChat) {
        window.location.href = `perfil.html?id=${usuarioActivoChat.id}`;
      }
    }

    // ============================================
    // VOLVER A LA LISTA (PARA M√ìVIL)
    // ============================================
    function volverALista() {
      // Detener actualizaci√≥n autom√°tica
      if (intervalActualizacion) {
        clearInterval(intervalActualizacion);
        intervalActualizacion = null;
      }

      // Mostrar lista, ocultar ventana de chat
      document.getElementById('chatListaContenedor').style.display = 'block';
      document.getElementById('chatVentanaContenedor').style.display = 'none';
      document.getElementById('btnVolverLista').style.display = 'none';

      // Ocultar chat activo
      document.getElementById('chatActivo').style.display = 'none';
      document.getElementById('chatVacio').style.display = 'flex';

      chatActivo = null;
      usuarioActivoChat = null;
    }

    // ============================================
    // MANEJAR CAMBIO DE TAMA√ëO DE PANTALLA
    // ============================================
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        // En pantallas grandes, mostrar ambos paneles
        document.getElementById('chatListaContenedor').style.display = 'block';
        document.getElementById('chatVentanaContenedor').style.display = 'flex';
        document.getElementById('btnVolverLista').style.display = 'none';
      } else {
        // En m√≥vil, mostrar solo uno seg√∫n el estado
        if (chatActivo) {
          document.getElementById('chatListaContenedor').style.display = 'none';
          document.getElementById('chatVentanaContenedor').style.display = 'flex';
          document.getElementById('btnVolverLista').style.display = 'block';
        } else {
          document.getElementById('chatListaContenedor').style.display = 'block';
          document.getElementById('chatVentanaContenedor').style.display = 'none';
          document.getElementById('btnVolverLista').style.display = 'none';
        }
      }
    });

    // ============================================
    // LIMPIAR INTERVALO AL SALIR
    // ============================================
    window.addEventListener('beforeunload', () => {
      if (intervalActualizacion) {
        clearInterval(intervalActualizacion);
      }
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
    });

    // ============================================
    // SISTEMA DE GRABACI√ìN DE VOZ
    // ============================================
    let mediaRecorder = null;
    let audioChunks = [];
    let grabando = false;

    async function toggleGrabacion() {
      if (!chatActivo) {
        mostrarNotificacion('Abre un chat primero', 'error');
        return;
      }

      if (!grabando) {
        await iniciarGrabacion();
      } else {
        detenerGrabacion();
      }
    }

    async function iniciarGrabacion() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          await subirAudio(audioBlob);
          
          // Detener todos los tracks del stream
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        grabando = true;

        // Cambiar apariencia del bot√≥n
        const btnVoz = document.getElementById('btnVoz');
        btnVoz.style.background = '#ff4444';
        btnVoz.innerHTML = '‚èπÔ∏è';
        btnVoz.title = 'Detener grabaci√≥n';

        mostrarNotificacion('üé§ Grabando...');

      } catch (error) {
        console.error('Error al iniciar grabaci√≥n:', error);
        mostrarNotificacion('Error al acceder al micr√≥fono', 'error');
      }
    }

    function detenerGrabacion() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        grabando = false;

        // Restaurar apariencia del bot√≥n
        const btnVoz = document.getElementById('btnVoz');
        btnVoz.style.background = 'var(--gris-medio)';
        btnVoz.innerHTML = 'üé§';
        btnVoz.title = 'Grabar mensaje de voz';
      }
    }

    async function subirAudio(audioBlob) {
      if (!chatActivo) return;

      try {
        mostrarNotificacion('Subiendo audio...');

        // Subir a Supabase Storage
        const nombreArchivo = `${usuarioActual.id}_${Date.now()}.webm`;
        
        const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
          .from('arnexu-files')
          .upload(`chat/voice/${nombreArchivo}`, audioBlob, {
            cacheControl: '3600',
            upsert: false
          });

        if (uploadError) throw uploadError;

        // Obtener URL p√∫blica
        const { data: urlData } = window.supabaseClient.storage
          .from('arnexu-files')
          .getPublicUrl(`chat/voice/${nombreArchivo}`);

        // Calcular duraci√≥n aproximada (en segundos)
        const duracion = Math.round(audioBlob.size / 16000); // Aproximaci√≥n

        // Guardar mensaje de voz
        const { error } = await window.supabaseClient
          .from('mensajes')
          .insert([{
            chat_id: chatActivo.id,
            remitente_id: usuarioActual.id,
            contenido: `Mensaje de voz (${duracion}s)`,
            tipo: 'audio',
            archivo_url: urlData.publicUrl,
            archivo_nombre: `audio_${duracion}s.webm`,
            archivo_tipo: 'audio/webm'
          }]);

        if (error) throw error;

        // Actualizar √∫ltimo mensaje del chat
        await window.supabaseClient
          .from('chats')
          .update({
            ultimo_mensaje: 'üé§ Mensaje de voz',
            ultimo_mensaje_fecha: new Date().toISOString()
          })
          .eq('id', chatActivo.id);

        mostrarNotificacion('Audio enviado');
        await cargarMensajes(chatActivo.id);
        await cargarChats();

      } catch (error) {
        console.error('Error subiendo audio:', error);
        mostrarNotificacion('Error al subir el audio', 'error');
      }
    }

    // ============================================
    // ELIMINAR MENSAJE
    // ============================================
    async function eliminarMensaje(mensajeId, tipoEliminacion) {
      const confirmText = tipoEliminacion === 'para_todos' 
        ? '¬øEliminar este mensaje para todos?' 
        : '¬øEliminar este mensaje para ti?';
      
      if (!confirm(confirmText)) return;

      try {
        if (tipoEliminacion === 'para_todos') {
          // Eliminar completamente de la base de datos
          const { error } = await window.supabaseClient
            .from('mensajes')
            .delete()
            .eq('id', mensajeId);

          if (error) throw error;
          mostrarNotificacion('Mensaje eliminado para todos');
        } else {
          // Marcar como eliminado solo para este usuario
          // Por ahora, simplemente lo eliminamos de la base de datos
          // En una versi√≥n m√°s avanzada, podr√≠as agregar una tabla de mensajes_eliminados
          const { error } = await window.supabaseClient
            .from('mensajes')
            .delete()
            .eq('id', mensajeId)
            .eq('remitente_id', usuarioActual.id);

          if (error) throw error;
          mostrarNotificacion('Mensaje eliminado');
        }

        await cargarMensajes(chatActivo.id);

      } catch (error) {
        console.error('Error eliminando mensaje:', error);
        mostrarNotificacion('Error al eliminar el mensaje', 'error');
      }
    }

    // ============================================
    // INICIALIZAR
    // ============================================
    inicializar();
  </script>
</body>
<footer style="background: var(--gris-oscuro); padding: 30px; margin-top: 50px; border-top: 1px solid var(--gris-medio); text-align: center;">
  <p style="color: var(--gris-neon); margin-bottom: 15px;">¬© 2025 Arnexu. Todos los derechos reservados.</p>
  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
    <a href="legal.html" style="color: var(--gris-neon);">Documentos Legales</a>
    <a href="terminos.html" style="color: var(--gris-neon);">T√©rminos</a>
    <a href="privacidad.html" style="color: var(--gris-neon);">Privacidad</a>
    <a href="cookies.html" style="color: var(--gris-neon);">Cookies</a>
    <a href="confidencialidad.html" style="color: var(--gris-neon);">Confidencialidad</a>
  </div>
</footer>
</html>