<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro| Arnexu</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js?v=1.0.1"></script>
<script src="js/app.js?v=1.0.1"></script>

</head>
<body>
  <div class="container" style="max-width: 500px; margin-top: 40px; margin-bottom: 40px;">
    <div class="text-center mb-20">
      <img src="arnexu-64x (1).png" alt="Logo Arnexu">
      <h1 style="font-size: 36px; font-weight: 800; background: linear-gradient(135deg, #ffffff, #5f5f5f); background-clip: text; -webkit-text-fill-color: transparent;">
        √önete a Arnexu
      </h1>
      <p style="color: var(--gris-neon);">Crea tu cuenta y empieza a conectar</p>
    </div>

    <div style="background: var(--gris-oscuro); padding: 30px; border-radius: 12px; border: 1px solid var(--gris-medio);">
      <form id="registroForm">
        <!-- Foto de Perfil (Opcional) -->
        <div class="form-group">
          <label class="form-label">Foto de Perfil (Opcional)</label>
          <div style="text-align: center; margin-bottom: 15px;">
            <img 
              id="previewFoto" 
              src="https://via.placeholder.com/120" 
              alt="Preview" 
              style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; background: var(--gris-medio); border: 3px solid var(--gris-neon);"
            >
          </div>
          <input 
            type="file" 
            id="fotoPerfil" 
            class="form-file" 
            accept="image/*"
          >
          <label for="fotoPerfil" class="form-file-label" style="width: 100%;">
            üì∑ Seleccionar Foto
          </label>
        </div>

        <!-- Nombre Completo -->
        <div class="form-group">
          <label class="form-label">Nombre y Apellido *</label>
          <input 
            type="text" 
            id="nombreCompleto" 
            class="form-input" 
            placeholder="Juan P√©rez"
            required
          >
        </div>

        <!-- Nombre de Usuario -->
        <div class="form-group">
          <label class="form-label">Nombre de Usuario *</label>
          <input 
            type="text" 
            id="nombreUsuario" 
            class="form-input" 
            placeholder="juanperez"
            required
          >
          <small style="color: var(--gris-neon); font-size: 12px;">Sin espacios ni caracteres especiales</small>
        </div>

        <!-- Email -->
        <div class="form-group">
          <label class="form-label">Correo Electr√≥nico *</label>
          <input 
            type="email" 
            id="email" 
            class="form-input" 
            placeholder="correo@ejemplo.com"
            required
          >
        </div>

        <!-- Tel√©fono -->
        <div class="form-group">
          <label class="form-label">Tel√©fono *</label>
          <input 
            type="tel" 
            id="telefono" 
            class="form-input" 
            placeholder="+57 300 123 4567"
            required
          >
        </div>

        <!-- Rol -->
        <div class="form-group">
          <label class="form-label">¬øQu√© te describe mejor? *</label>
          <select id="rol" class="form-select" required>
            <option value="">Selecciona una opci√≥n</option>
            <option value="emprendedor">üöÄ Emprendedor</option>
            <option value="inversor">üíº Inversor</option>
            <option value="ambos">‚ö° Ambos</option>
          </select>
        </div>

        <!-- Contrase√±a -->
        <div class="form-group">
          <label class="form-label">Contrase√±a *</label>
          <input 
            type="password" 
            id="password" 
            class="form-input" 
            placeholder="M√≠nimo 6 caracteres"
            required
          >
        </div>

        <!-- Confirmar Contrase√±a -->
        <div class="form-group">
          <label class="form-label">Confirmar Contrase√±a *</label>
          <input 
            type="password" 
            id="confirmarPassword" 
            class="form-input" 
            placeholder="Repite tu contrase√±a"
            required
          >
        </div>

        <!-- T√©rminos y Condiciones -->
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input 
              type="checkbox" 
              id="terminos" 
              required
              style="width: 20px; height: 20px; cursor: pointer;"
            >
            <span style="color: var(--gris-neon); font-size: 14px;">
              Acepto los 
              <a href="terminos.html" target="_blank" style="color: var(--acento); text-decoration: underline;">
                t√©rminos y condiciones
              </a> 
              de Arnexu
            </span>
          </label>
        </div>

        <button type="submit" class="btn btn-primary btn-full">
          REGISTRARSE
        </button>
      </form>

      <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gris-medio);">
        <p style="color: var(--gris-neon); font-size: 14px;">
          ¬øYa tienes cuenta? 
          <a href="index.html" style="color: var(--acento); text-decoration: none; font-weight: 600;">
            Inicia sesi√≥n
          </a>
        </p>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script>
    // ============================================
    // PREVIEW DE FOTO DE PERFIL
    // ============================================
    document.getElementById('fotoPerfil').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('previewFoto').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // ============================================
    // MANEJO DEL FORMULARIO DE REGISTRO
    // ============================================
    document.getElementById('registroForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Obtener valores del formulario
      const nombreCompleto = document.getElementById('nombreCompleto').value.trim();
      const nombreUsuario = document.getElementById('nombreUsuario').value.trim().toLowerCase();
      const email = document.getElementById('email').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const rol = document.getElementById('rol').value;
      const password = document.getElementById('password').value;
      const confirmarPassword = document.getElementById('confirmarPassword').value;
      const fotoPerfil = document.getElementById('fotoPerfil').files[0];

      // Validaciones
      if (password !== confirmarPassword) {
        mostrarNotificacion('Las contrase√±as no coinciden', 'error');
        return;
      }

      if (password.length < 6) {
        mostrarNotificacion('La contrase√±a debe tener al menos 6 caracteres', 'error');
        return;
      }

      if (!/^[a-z0-9_]+$/.test(nombreUsuario)) {
        mostrarNotificacion('El nombre de usuario solo puede contener letras, n√∫meros y guiones bajos', 'error');
        return;
      }

      try {
        // 1. Registrar usuario en Supabase Auth
        const { data: authData, error: authError } = await window.supabaseClient.auth.signUp({
          email: email,
          password: password,
          phone: telefono,
        });

        if (authError) throw authError;

        // 2. Subir foto de perfil (si existe)
        let fotoUrl = null;
        if (fotoPerfil) {
          const nombreArchivo = `${authData.user.id}_${Date.now()}.jpg`;
          const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
            .from('arnexu-files')
            .upload(`avatars/${nombreArchivo}`, fotoPerfil);

          if (!uploadError) {
            const { data: urlData } = window.supabaseClient.storage
              .from('arnexu-files')
              .getPublicUrl(`avatars/${nombreArchivo}`);
            fotoUrl = urlData.publicUrl;
          }
        }

        // 3. Crear perfil del usuario en la tabla usuarios
        const { error: perfilError } = await window.supabaseClient
          .from('usuarios')
          .insert([{
            id: authData.user.id,
            email: email,
            telefono: telefono,
            nombre_completo: nombreCompleto,
            nombre_usuario: nombreUsuario,
            foto_perfil: fotoUrl,
            rol: rol,
            biografia: ''
          }]);

        if (perfilError) throw perfilError;

        // Registro exitoso
        mostrarNotificacion('¬°Registro exitoso! Redirigiendo...');
        setTimeout(() => {
          window.location.href = 'inicio.html';
        }, 1500);

      } catch (error) {
        console.error('Error en registro:', error);
        
        if (error.message.includes('already registered')) {
          mostrarNotificacion('Este email ya est√° registrado', 'error');
        } else if (error.message.includes('duplicate')) {
          mostrarNotificacion('Este nombre de usuario o tel√©fono ya est√° en uso', 'error');
        } else {
          mostrarNotificacion('Error al registrarse. Intenta de nuevo.', 'error');
        }
      }
    });
  </script>

    <!-- Agregar al final del body en todas las p√°ginas -->
<div id="cookieBanner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--gris-oscuro); padding: 20px; border-top: 2px solid var(--acento); z-index: 10000;">
  <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 20px;">
    <p style="color: var(--gris-neon); margin: 0;">
      üç™ Usamos cookies para mejorar tu experiencia. 
      <a href="cookies.html" style="color: var(--acento);">M√°s informaci√≥n</a>
    </p>
    <button onclick="aceptarCookies()" class="btn btn-primary">
      Aceptar
    </button>
  </div>
</div>

<script>
function aceptarCookies() {
  localStorage.setItem('cookies_aceptadas', 'true');
  document.getElementById('cookieBanner').style.display = 'none';
}

// Mostrar banner si no ha aceptado
if (!localStorage.getItem('cookies_aceptadas')) {
  document.getElementById('cookieBanner').style.display = 'block';
}
</script>
</body>
<footer style="background: var(--gris-oscuro); padding: 30px; margin-top: 50px; border-top: 1px solid var(--gris-medio); text-align: center;">
  <p style="color: var(--gris-neon); margin-bottom: 15px;">¬© 2025 Arnexu. Todos los derechos reservados.</p>
  <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
    <a href="legal.html" style="color: var(--gris-neon);">Documentos Legales</a>
    <a href="terminos.html" style="color: var(--gris-neon);">T√©rminos</a>
    <a href="privacidad.html" style="color: var(--gris-neon);">Privacidad</a>
    <a href="cookies.html" style="color: var(--gris-neon);">Cookies</a>
    <a href="confidencialidad.html" style="color: var(--gris-neon);">Confidencialidad</a>
  </div>
</footer>
</html>