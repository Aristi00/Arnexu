<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IA Mentor - Arnexu</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js?v=1.0.1"></script>
  <script src="js/app.js?v=1.0.1"></script>
  <script src="js/badge-notifications.js?v=1.0.0"></script>
  
  <style>
    .ia-container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
      height: calc(100vh - 140px);
      margin-top: 30px;
    }
    
    .ia-sidebar {
      background: var(--gris-oscuro);
      border-radius: 12px;
      padding: 20px;
      overflow-y: auto;
      border: 1px solid var(--gris-medio);
    }
    
    .ia-chat-area {
      background: var(--gris-oscuro);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--gris-medio);
      overflow: hidden;
    }
    
    .ia-header {
      padding: 20px;
      border-bottom: 1px solid var(--gris-medio);
      display: flex;
      align-items: center;
      gap: 15px;
      background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,150,255,0.1) 100%);
    }
    
    .ia-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00ff88 0%, #0096ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      box-shadow: 0 4px 12px rgba(0,255,136,0.3);
    }
    
    .ia-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .ia-message {
      display: flex;
      gap: 12px;
      max-width: 85%;
      animation: fadeIn 0.3s;
    }
    
    .ia-message.user {
      margin-left: auto;
      flex-direction: row-reverse;
    }
    
    .ia-message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .ia-message.assistant .ia-message-avatar {
      background: linear-gradient(135deg, #00ff88 0%, #0096ff 100%);
    }
    
    .ia-message.user .ia-message-avatar {
      background: var(--gris-medio);
    }
    
    .ia-message-content {
      background: var(--gris-medio);
      padding: 15px;
      border-radius: 12px;
      line-height: 1.6;
    }
    
    .ia-message.assistant .ia-message-content {
      background: linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,150,255,0.15) 100%);
      border: 1px solid rgba(0,255,136,0.3);
    }
    
    .ia-input-area {
      padding: 20px;
      border-top: 1px solid var(--gris-medio);
      background: rgba(0,0,0,0.2);
    }
    
    .ia-input-container {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    
    .ia-input {
      flex: 1;
      background: var(--gris-medio);
      border: 1px solid var(--gris-neon);
      border-radius: 12px;
      padding: 15px;
      color: var(--blanco);
      font-family: 'Montserrat';
      font-size: 14px;
      resize: none;
      min-height: 50px;
      max-height: 150px;
    }
    
    .conversacion-item {
      padding: 12px;
      background: var(--gris-medio);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .conversacion-item:hover {
      background: rgba(0,255,136,0.1);
      border-color: var(--acento);
    }
    
    .conversacion-item.active {
      background: linear-gradient(135deg, rgba(0,255,136,0.2) 0%, rgba(0,150,255,0.2) 100%);
      border-color: var(--acento);
    }
    
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 15px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--acento);
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
      30% { transform: translateY(-10px); opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .uso-diario {
      background: rgba(0,255,136,0.1);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      border: 1px solid rgba(0,255,136,0.3);
    }
    
    .uso-diario-numero {
      font-size: 24px;
      font-weight: 700;
      color: var(--acento);
    }
    
    .especialidad-btn {
      padding: 8px 12px;
      background: var(--gris-medio);
      border: 1px solid var(--gris-neon);
      border-radius: 20px;
      color: var(--blanco);
      cursor: pointer;
      font-family: 'Montserrat';
      font-size: 12px;
      transition: all 0.2s;
      margin: 4px;
    }
    
    .especialidad-btn:hover {
      background: var(--acento);
      color: var(--gris-oscuro);
      border-color: var(--acento);
    }
    
    .badge-contador {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      padding: 2px 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    @media (max-width: 768px) {
      .ia-container {
        grid-template-columns: 1fr;
        height: auto;
      }
      .ia-sidebar {
        display: none;
      }
      .ia-sidebar.mobile-show {
        display: block;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-content">
      <a href="inicio.html"><img src="arnexu-64x (1).png" alt="Logo Arnexu"></a>
      <ul class="navbar-menu">
        <li><a href="inicio.html"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></a></li>
        <li><a href="crear.html"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></li>
        <li style="position: relative;"><a href="chat.html"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></a><span id="badgeGlobal" class="badge-contador" style="display: none;"></span></li>
        <li><a href="ia-mentor.html" style="color: var(--acento);"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></a></li>
        <li><a href="perfil.html"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></a></li>
        <li><a href="#" onclick="logout()" style="color: var(--error);"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></a></li>
      </ul>
    </div>
  </nav>

  <div class="container-wide">
    <div class="ia-container">
      <!-- Sidebar -->
      <div class="ia-sidebar" id="sidebarConversaciones">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="font-size: 18px;">üí¨ Conversaciones</h3>
          <button class="btn-icon" onclick="nuevaConversacion()" title="Nueva conversaci√≥n">‚ûï</button>
        </div>

        <div class="uso-diario">
          <div style="font-size: 12px; margin-bottom: 5px;">Mensajes hoy</div>
          <div class="uso-diario-numero" id="usoHoy">0/50</div>
          <div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">Se reinicia cada 24h</div>
        </div>

        <div style="margin-bottom: 15px;">
          <h4 style="font-size: 14px; margin-bottom: 10px;">üéØ Especializaciones</h4>
          <button class="especialidad-btn" onclick="aplicarPrompt('marketing')">üìà Marketing</button>
          <button class="especialidad-btn" onclick="aplicarPrompt('diseno')">üé® Dise√±o</button>
          <button class="especialidad-btn" onclick="aplicarPrompt('estrategia')">üéØ Estrategia</button>
          <button class="especialidad-btn" onclick="aplicarPrompt('legal')">‚öñÔ∏è Legal</button>
          <button class="especialidad-btn" onclick="aplicarPrompt('finanzas')">üí∞ Finanzas</button>
          <button class="especialidad-btn" onclick="aplicarPrompt('tech')">üíª Tecnolog√≠a</button>
        </div>

        <div id="listaConversaciones">
          <div class="loading">Cargando...</div>
        </div>
      </div>

      <!-- Chat Area -->
      <div class="ia-chat-area">
        <div class="ia-header">
          <div class="ia-avatar">ü§ñ</div>
          <div>
            <h2 style="font-size: 20px; margin-bottom: 5px;">IA Mentor Empresarial</h2>
            <p style="font-size: 13px; color: var(--gris-neon);">Combinaci√≥n de Gates, Zuckerberg, Musk y m√°s expertos</p>
          </div>
        </div>

        <div class="ia-messages" id="mensajesIA">
          <div class="ia-message assistant">
            <div class="ia-message-avatar">ü§ñ</div>
            <div class="ia-message-content">
              <p><strong>¬°Hola! Soy tu mentor empresarial con IA.</strong></p>
              <p style="margin-top: 10px;">Combino la experiencia de los mejores empresarios del mundo para ayudarte con:</p>
              <ul style="margin: 10px 0; padding-left: 20px;">
                <li>üìà Estrategias de marketing y crecimiento</li>
                <li>üé® Dise√±o y branding</li>
                <li>üí∞ Finanzas y fundraising</li>
                <li>‚öñÔ∏è Aspectos legales</li>
                <li>üíª Tecnolog√≠a y desarrollo</li>
                <li>üöÄ Escalamiento de negocio</li>
              </ul>
              <p style="margin-top: 10px;">¬øEn qu√© puedo ayudarte hoy?</p>
            </div>
          </div>
        </div>

        <div class="ia-input-area">
          <div class="ia-input-container">
            <textarea 
              id="iaInput" 
              class="ia-input" 
              placeholder="Escribe tu pregunta o describe tu desaf√≠o empresarial..."
              onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); enviarMensajeIA(); }"
            ></textarea>
            <button class="btn btn-primary" onclick="enviarMensajeIA()" id="btnEnviar">
              Enviar
            </button>
          </div>
          <div style="font-size: 11px; color: var(--gris-neon); margin-top: 8px; text-align: center;">
            üí° Tip: S√© espec√≠fico en tus preguntas para mejores respuestas
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let usuarioActual = null;
    let conversacionActual = null;
    let procesando = false;

    // Sistema de prompts especializados
    const PROMPTS_SISTEMA = {
      base: `Eres un mentor empresarial experto que combina la sabidur√≠a de Bill Gates, Mark Zuckerberg, Elon Musk, Jeff Bezos y otros grandes emprendedores. 

Respondes en espa√±ol de forma clara, pr√°ctica y directa. Das consejos espec√≠ficos y accionables, no teor√≠a gen√©rica. Eres honesto sobre riesgos y desaf√≠os, pero siempre motivacional.

Tus respuestas son concisas (m√°ximo 250 palabras) a menos que el usuario pida m√°s detalle.`,
      
      marketing: `Enf√≥cate en estrategias de marketing digital, growth hacking, adquisici√≥n de usuarios, viralidad, redes sociales, content marketing y posicionamiento de marca. Piensa como un CMO de una startup tech exitosa.`,
      
      diseno: `Especial√≠zate en dise√±o UX/UI, branding, identidad visual, psicolog√≠a del color, tipograf√≠a y dise√±o de productos digitales. Combina la est√©tica de Apple con la funcionalidad de Google.`,
      
      estrategia: `C√©ntrate en estrategia de negocio, modelos de monetizaci√≥n, an√°lisis de mercado, ventajas competitivas, pivotes estrat√©gicos y planes de crecimiento escalable.`,
      
      legal: `Aborda temas legales para startups: constituci√≥n de empresas, contratos, propiedad intelectual, privacidad de datos (GDPR), t√©rminos de servicio y aspectos regulatorios. Siempre recomienda consultar un abogado para lo espec√≠fico.`,
      
      finanzas: `Asesora sobre fundraising, valoraci√≥n, m√©tricas financieras (CAC, LTV, burn rate), pitch decks, inversores √°ngeles, VCs, bootstrapping y gesti√≥n de capital.`,
      
      tech: `Gu√≠a en decisiones tecnol√≥gicas: stack t√©cnico, arquitectura, escalabilidad, seguridad, APIs, bases de datos, cloud computing y mejores pr√°cticas de desarrollo.`
    };

    let promptActual = PROMPTS_SISTEMA.base;

    async function inicializar() {
      await protegerPagina();
      usuarioActual = await getCurrentUser();
      await cargarConversaciones();
      await verificarUsoHoy();
    }

    async function cargarConversaciones() {
      try {
        const { data, error } = await window.supabaseClient
          .from('conversaciones_ia')
          .select('*')
          .eq('usuario_id', usuarioActual.id)
          .order('updated_at', { ascending: false })
          .limit(20);

        if (error) throw error;

        const lista = document.getElementById('listaConversaciones');
        
        if (!data || data.length === 0) {
          lista.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gris-neon); font-size: 13px;">No hay conversaciones<br>¬°Inicia una nueva!</div>';
          return;
        }

        lista.innerHTML = data.map(conv => `
          <div class="conversacion-item ${conversacionActual?.id === conv.id ? 'active' : ''}" onclick="abrirConversacion('${conv.id}')">
            <div style="font-weight: 600; font-size: 13px; margin-bottom: 5px;">${conv.titulo}</div>
            <div style="font-size: 11px; color: var(--gris-neon);">${formatearFecha(conv.updated_at)}</div>
          </div>
        `).join('');

        if (!conversacionActual && data.length > 0) {
          await abrirConversacion(data[0].id);
        }
      } catch (error) {
        console.error('Error cargando conversaciones:', error);
      }
    }

    async function nuevaConversacion() {
      try {
        const { data, error } = await window.supabaseClient
          .from('conversaciones_ia')
          .insert([{
            usuario_id: usuarioActual.id,
            titulo: 'Nueva conversaci√≥n'
          }])
          .select()
          .single();

        if (error) throw error;

        conversacionActual = data;
        document.getElementById('mensajesIA').innerHTML = `
          <div class="ia-message assistant">
            <div class="ia-message-avatar">ü§ñ</div>
            <div class="ia-message-content">
              <p><strong>¬°Nueva conversaci√≥n iniciada!</strong></p>
              <p style="margin-top: 10px;">¬øEn qu√© puedo ayudarte hoy?</p>
            </div>
          </div>
        `;
        
        await cargarConversaciones();
      } catch (error) {
        console.error('Error creando conversaci√≥n:', error);
        mostrarNotificacion('Error al crear conversaci√≥n', 'error');
      }
    }

    async function abrirConversacion(conversacionId) {
      try {
        const { data, error } = await window.supabaseClient
          .from('conversaciones_ia')
          .select('*')
          .eq('id', conversacionId)
          .single();

        if (error) throw error;

        conversacionActual = data;
        await cargarMensajesIA(conversacionId);
        await cargarConversaciones();
      } catch (error) {
        console.error('Error abriendo conversaci√≥n:', error);
      }
    }

    async function cargarMensajesIA(conversacionId) {
      try {
        const { data, error } = await window.supabaseClient
          .from('mensajes_ia')
          .select('*')
          .eq('conversacion_id', conversacionId)
          .order('created_at', { ascending: true });

        if (error) throw error;

        const mensajesDiv = document.getElementById('mensajesIA');
        
        if (!data || data.length === 0) {
          mensajesDiv.innerHTML = `
            <div class="ia-message assistant">
              <div class="ia-message-avatar">ü§ñ</div>
              <div class="ia-message-content">
                <p><strong>¬°Hola! Soy tu mentor empresarial con IA.</strong></p>
                <p style="margin-top: 10px;">¬øEn qu√© puedo ayudarte?</p>
              </div>
            </div>
          `;
          return;
        }

        mensajesDiv.innerHTML = data.map(msg => `
          <div class="ia-message ${msg.rol}">
            <div class="ia-message-avatar">${msg.rol === 'assistant' ? 'ü§ñ' : 'üë§'}</div>
            <div class="ia-message-content">
              ${formatearTextoIA(msg.contenido)}
            </div>
          </div>
        `).join('');

        mensajesDiv.scrollTop = mensajesDiv.scrollHeight;
      } catch (error) {
        console.error('Error cargando mensajes:', error);
      }
    }

    async function enviarMensajeIA() {
      const input = document.getElementById('iaInput');
      const contenido = input.value.trim();
      
      if (!contenido || procesando) return;

      // Verificar l√≠mite de uso
      const puedeEnviar = await verificarYActualizarUso();
      if (!puedeEnviar) {
        mostrarNotificacion('Has alcanzado el l√≠mite de 50 mensajes diarios. Vuelve ma√±ana.', 'error');
        return;
      }

      if (!conversacionActual) {
        await nuevaConversacion();
      }

      procesando = true;
      document.getElementById('btnEnviar').disabled = true;
      document.getElementById('btnEnviar').textContent = '...';

      try {
        // Guardar mensaje del usuario
        const { data: mensajeUsuario, error: errorUsuario } = await window.supabaseClient
          .from('mensajes_ia')
          .insert([{
            conversacion_id: conversacionActual.id,
            usuario_id: usuarioActual.id,
            rol: 'user',
            contenido: contenido
          }])
          .select()
          .single();

        if (errorUsuario) throw errorUsuario;

        // Mostrar mensaje del usuario
        const mensajesDiv = document.getElementById('mensajesIA');
        mensajesDiv.innerHTML += `
          <div class="ia-message user">
            <div class="ia-message-avatar">üë§</div>
            <div class="ia-message-content">${formatearTextoIA(contenido)}</div>
          </div>
        `;

        // Mostrar indicador de escritura
        mensajesDiv.innerHTML += `
          <div class="ia-message assistant" id="typing-indicator">
            <div class="ia-message-avatar">ü§ñ</div>
            <div class="ia-message-content">
              <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
              </div>
            </div>
          </div>
        `;
        mensajesDiv.scrollTop = mensajesDiv.scrollHeight;

        input.value = '';

        // Llamar a la API de Groq
        const respuestaIA = await obtenerRespuestaIA(contenido);

        // Eliminar indicador de escritura
        document.getElementById('typing-indicator').remove();

        // Guardar respuesta de la IA
        await window.supabaseClient
          .from('mensajes_ia')
          .insert([{
            conversacion_id: conversacionActual.id,
            usuario_id: usuarioActual.id,
            rol: 'assistant',
            contenido: respuestaIA
          }]);

        // Mostrar respuesta de la IA
        mensajesDiv.innerHTML += `
          <div class="ia-message assistant">
            <div class="ia-message-avatar">ü§ñ</div>
            <div class="ia-message-content">${formatearTextoIA(respuestaIA)}</div>
          </div>
        `;
        mensajesDiv.scrollTop = mensajesDiv.scrollHeight;

        // Actualizar t√≠tulo si es el primer mensaje
        if (conversacionActual.titulo === 'Nueva conversaci√≥n') {
          const titulo = contenido.substring(0, 50) + (contenido.length > 50 ? '...' : '');
          await window.supabaseClient
            .from('conversaciones_ia')
            .update({ titulo: titulo })
            .eq('id', conversacionActual.id);
          await cargarConversaciones();
        }

        // Actualizar updated_at
        await window.supabaseClient
          .from('conversaciones_ia')
          .update({ updated_at: new Date().toISOString() })
          .eq('id', conversacionActual.id);

      } catch (error) {
        console.error('Error enviando mensaje:', error);
        mostrarNotificacion('Error al enviar mensaje. Intenta de nuevo.', 'error');
        document.getElementById('typing-indicator')?.remove();
      } finally {
        procesando = false;
        document.getElementById('btnEnviar').disabled = false;
        document.getElementById('btnEnviar').textContent = 'Enviar';
      }
    }

    async function obtenerRespuestaIA(pregunta) {
      try {
        // ‚ö†Ô∏è IMPORTANTE: Reemplaza con tu API key de Groq
        // Obtenerla en: https://console.groq.com/keys
        const GROQ_API_KEY = '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';
        
        // Obtener historial reciente para contexto
        const { data: historial } = await window.supabaseClient
          .from('mensajes_ia')
          .select('rol, contenido')
          .eq('conversacion_id', conversacionActual.id)
          .order('created_at', { ascending: false })
          .limit(10);

        // Construir mensajes para Groq (formato OpenAI compatible)
        const messages = [
          {
            role: 'system',
            content: promptActual
          }
        ];

        // Agregar historial (en orden correcto)
        if (historial && historial.length > 0) {
          historial.reverse().forEach(msg => {
            messages.push({
              role: msg.rol === 'user' ? 'user' : 'assistant',
              content: msg.contenido
            });
          });
        }

        // Agregar pregunta actual
        messages.push({
          role: 'user',
          content: pregunta
        });

        // Llamar a Groq API
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${GROQ_API_KEY}`
          },
          body: JSON.stringify({
            model: 'llama-3.3-70b-versatile', // Modelo r√°pido y potente
            messages: messages,
            temperature: 0.7,
            max_tokens: 1024,
            top_p: 0.95,
            stream: false
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Error de Groq:', errorData);
          
          // Manejar errores espec√≠ficos
          if (response.status === 429) {
            return '‚ö†Ô∏è Has alcanzado el l√≠mite de solicitudes. Espera unos segundos e intenta de nuevo.';
          }
          if (response.status === 401) {
            return '‚ùå API key inv√°lida. Verifica tu clave en Groq Console.';
          }
          
          throw new Error(`Error en API: ${response.status}`);
        }

        const data = await response.json();
        
        // Extraer la respuesta
        if (data.choices && data.choices[0]?.message?.content) {
          return data.choices[0].message.content;
        } else {
          console.error('Respuesta inesperada:', data);
          return 'Lo siento, no pude generar una respuesta. Por favor intenta de nuevo.';
        }

      } catch (error) {
        console.error('Error llamando a Groq:', error);
        return '‚ùå Lo siento, tuve un problema al procesar tu pregunta. Verifica tu conexi√≥n e intenta de nuevo.';
      }
    }

    async function verificarUsoHoy() {
      try {
        const hoy = new Date().toISOString().split('T')[0];
        
        const { data, error } = await window.supabaseClient
          .from('uso_ia')
          .select('*')
          .eq('usuario_id', usuarioActual.id)
          .eq('fecha', hoy)
          .maybeSingle();

        if (error && error.code !== 'PGRST116') {
          console.error('Error verificando uso:', error);
          return 0;
        }

        const mensajesUsados = data?.mensajes_enviados || 0;
        const elementoUso = document.getElementById('usoHoy');
        if (elementoUso) {
          elementoUso.textContent = `${mensajesUsados}/50`;
        }

        return mensajesUsados;
      } catch (error) {
        console.error('Error en verificarUsoHoy:', error);
        return 0;
      }
    }

    async function verificarYActualizarUso() {
      try {
        const hoy = new Date().toISOString().split('T')[0];
        
        const { data: existing, error: errorSelect } = await window.supabaseClient
          .from('uso_ia')
          .select('*')
          .eq('usuario_id', usuarioActual.id)
          .eq('fecha', hoy)
          .maybeSingle();

        if (errorSelect && errorSelect.code !== 'PGRST116') {
          console.error('Error al verificar uso:', errorSelect);
          return true; // En caso de error, permitir env√≠o
        }

        if (existing) {
          if (existing.mensajes_enviados >= 50) {
            return false; // L√≠mite alcanzado
          }
          
          const { error: errorUpdate } = await window.supabaseClient
            .from('uso_ia')
            .update({
              mensajes_enviados: existing.mensajes_enviados + 1
            })
            .eq('usuario_id', usuarioActual.id)
            .eq('fecha', hoy);

          if (errorUpdate) throw errorUpdate;
        } else {
          const { error: errorInsert } = await window.supabaseClient
            .from('uso_ia')
            .insert([{
              usuario_id: usuarioActual.id,
              fecha: hoy,
              mensajes_enviados: 1
            }]);

          if (errorInsert) throw errorInsert;
        }

        await verificarUsoHoy();
        return true;
      } catch (error) {
        console.error('Error verificando uso:', error);
        return true; // En caso de error, permitir env√≠o
      }
    }

    function aplicarPrompt(tipo) {
      if (PROMPTS_SISTEMA[tipo]) {
        promptActual = PROMPTS_SISTEMA.base + '\n\n' + PROMPTS_SISTEMA[tipo];
        mostrarNotificacion(`Modo ${tipo} activado`);
      }
    }

    function formatearTextoIA(texto) {
      // Convertir markdown simple a HTML
      let html = texto
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">$1</code>')
        .replace(/\n\n/g, '</p><p style="margin-top: 10px;">')
        .replace(/\n/g, '<br>');
      
      // Detectar listas con - o ‚Ä¢
      const lineas = html.split('<br>');
      let dentroLista = false;
      let resultado = [];
      
      for (let i = 0; i < lineas.length; i++) {
        const linea = lineas[i].trim();
        
        if (linea.startsWith('- ') || linea.startsWith('‚Ä¢ ')) {
          if (!dentroLista) {
            resultado.push('<ul style="margin: 10px 0; padding-left: 20px;">');
            dentroLista = true;
          }
          resultado.push('<li>' + linea.substring(2) + '</li>');
        } else {
          if (dentroLista) {
            resultado.push('</ul>');
            dentroLista = false;
          }
          if (linea) {
            resultado.push(linea + '<br>');
          }
        }
      }
      
      if (dentroLista) {
        resultado.push('</ul>');
      }
      
      html = resultado.join('');
      
      return `<p>${html}</p>`;
    }

    // Funci√≥n helper para formatear fechas
    function formatearFecha(fecha) {
      const date = new Date(fecha);
      const ahora = new Date();
      const diff = ahora - date;
      
      const minutos = Math.floor(diff / 60000);
      const horas = Math.floor(diff / 3600000);
      const dias = Math.floor(diff / 86400000);
      
      if (minutos < 1) return 'Ahora';
      if (minutos < 60) return `Hace ${minutos}m`;
      if (horas < 24) return `Hace ${horas}h`;
      if (dias < 7) return `Hace ${dias}d`;
      
      return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
    }

    inicializar();
  </script>

  <footer style="background: var(--gris-oscuro); padding: 30px; margin-top: 50px; border-top: 1px solid var(--gris-medio); text-align: center;">
    <p style="color: var(--gris-neon); margin-bottom: 15px;">¬© 2025 Arnexu. Todos los derechos reservados.</p>
    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
      <a href="legal.html" style="color: var(--gris-neon);">Documentos Legales</a>
      <a href="terminos.html" style="color: var(--gris-neon);">T√©rminos</a>
      <a href="privacidad.html" style="color: var(--gris-neon);">Privacidad</a>
      <a href="cookies.html" style="color: var(--gris-neon);">Cookies</a>
      <a href="confidencialidad.html" style="color: var(--gris-neon);">Confidencialidad</a>
    </div>
  </footer>
</body>
</html>